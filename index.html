<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>éŸ³é«˜å°„é¶ - æ‰‹æœºç‰ˆ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            touch-action: manipulation;
        }

        h1, h2, h3, .btn-text {
            font-family: 'Nunito', sans-serif;
        }

        /* å½•éŸ³è„‰å†²åŠ¨ç”» - ä¿®å¤ç‰ˆ */
        @keyframes recording-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }
        }

        .record-btn.recording {
            animation: recording-pulse 1.5s ease-out infinite;
            background: linear-gradient(to bottom right, #dc2626, #b91c1c);
        }

        .record-btn.recording:active {
            animation: none;
        }

        /* éŸ³è‰²æŒ‰é’®é€‰ä¸­çŠ¶æ€ */
        .sound-btn.active {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .mobile-touch-btn {
                min-height: 48px;
                min-width: 48px;
            }

            .record-btn {
                min-height: 120px;
            }
        }

        /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
        button {
            touch-action: manipulation;
        }

        /* è°ƒè¯•ä¿¡æ¯ */
        #debugInfo {
            font-size: 10px;
            color: #94a3b8;
            word-break: break-all;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Header -->
    <header class="w-full max-w-lg mb-4">
        <h1 class="text-3xl font-extrabold text-center bg-gradient-to-r from-indigo-600 to-violet-600 bg-clip-text text-transparent mb-1">
            ğŸ¯ éŸ³é«˜å°„é¶
        </h1>
        <p class="text-center text-slate-500 text-xs font-medium">æ‰‹æœºç‰ˆ - Pitch Target Training</p>
    </header>

    <!-- ç¤ºä¾‹éŸ³æ’­æ”¾åŒº -->
    <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg p-4 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                    </svg>
                </div>
                <div class="min-w-0">
                    <p class="text-sm font-semibold text-slate-700">ç›®æ ‡éŸ³ç¤ºèŒƒ</p>
                    <p id="targetNoteDisplay" class="text-xs text-slate-500 truncate">ç‚¹å‡»å³ä¾§æ’­æ”¾</p>
                </div>
            </div>
            <button id="playDemoBtn" class="mobile-touch-btn px-5 py-3 bg-gradient-to-r from-indigo-600 to-violet-600 active:scale-95 text-white font-bold rounded-xl transition-all duration-200 shadow-md flex items-center gap-2 flex-shrink-0">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                æ’­æ”¾
            </button>
        </div>
    </div>

    <!-- å°„é¶å¯è§†åŒ–åŒºåŸŸ -->
    <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg p-4 mb-4 relative">
        <canvas id="targetCanvas" class="w-full rounded-lg" style="height: 280px;"></canvas>

        <!-- å‘½ä¸­ç»“æœæ˜¾ç¤º -->
        <div id="resultOverlay" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300 rounded-2xl bg-white/90">
            <div class="text-center p-6">
                <div id="resultIcon" class="text-5xl mb-2"></div>
                <p id="resultText" class="text-xl font-bold"></p>
            </div>
        </div>
    </div>

    <!-- éŸ³è‰²ç±»åˆ«é€‰æ‹© -->
    <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg p-4 mb-4">
        <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
            <svg class="w-4 h-4 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
            </svg>
            é€‰æ‹©éŸ³è‰²
        </h3>
        <div class="grid grid-cols-4 gap-2">
            <button class="sound-btn active mobile-touch-btn px-3 py-3 rounded-xl text-center font-semibold transition-all duration-200 flex flex-col items-center gap-1 text-xs" data-sound="triangle">
                <span class="text-2xl">ğŸ¹</span>
                <span>ä¸‰è§’æ³¢</span>
            </button>
            <button class="sound-btn mobile-touch-btn px-3 py-3 rounded-xl text-center font-semibold text-slate-700 transition-all duration-200 flex flex-col items-center gap-1 text-xs bg-slate-50" data-sound="sine">
                <span class="text-2xl">ğŸµ</span>
                <span>æ­£å¼¦æ³¢</span>
            </button>
            <button class="sound-btn mobile-touch-btn px-3 py-3 rounded-xl text-center font-semibold text-slate-700 transition-all duration-200 flex flex-col items-center gap-1 text-xs bg-slate-50" data-sound="piano">
                <span class="text-2xl">ğŸ¼</span>
                <span>é’¢ç´</span>
            </button>
            <button class="sound-btn mobile-touch-btn px-3 py-3 rounded-xl text-center font-semibold text-slate-700 transition-all duration-200 flex flex-col items-center gap-1 text-xs bg-slate-50" data-sound="voice">
                <span class="text-2xl">ğŸ¤</span>
                <span>äººå£°</span>
            </button>
        </div>
    </div>

    <!-- å½•éŸ³æ§åˆ¶åŒº -->
    <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg p-4 mb-4">
        <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
            <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
            </svg>
            å½•éŸ³æµ‹è¯•
        </h3>

        <button id="recordBtn" class="record-btn w-full bg-gradient-to-br from-red-500 to-red-600 active:from-red-600 active:to-red-700 active:scale-95 text-white text-lg font-bold rounded-2xl transition-all duration-200 shadow-lg flex flex-col items-center justify-center gap-2 select-none">
            <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="6"/>
            </svg>
            <span class="text-base">æŒ‰ä½è¯´è¯</span>
        </button>

        <p id="recordingStatus" class="text-center text-sm text-slate-500 mt-3 min-h-[24px]">
            å…ˆæ’­æ”¾ç¤ºèŒƒéŸ³ï¼Œç„¶åæŒ‰ä½å½•éŸ³
        </p>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <p id="debugInfo" class="text-center text-xs text-slate-400 mt-2 hidden"></p>
    </div>

    <!-- ç»“æœæç¤ºåŒº -->
    <div class="w-full max-w-lg bg-gradient-to-br from-indigo-50 to-violet-50 rounded-2xl shadow-lg p-4 border-2 border-indigo-100 mb-4">
        <h3 class="text-sm font-bold text-slate-700 mb-2">æ£€æµ‹ç»“æœ</h3>
        <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="bg-white/80 rounded-lg p-2">
                <span class="text-xs text-slate-500 block">ç›®æ ‡éŸ³</span>
                <span id="targetNoteResult" class="font-bold text-indigo-600">-</span>
            </div>
            <div class="bg-white/80 rounded-lg p-2">
                <span class="text-xs text-slate-500 block">ä½ çš„éŸ³é«˜</span>
                <span id="userPitchResult" class="font-bold text-violet-600">-</span>
            </div>
            <div class="bg-white/80 rounded-lg p-2 col-span-2">
                <span class="text-xs text-slate-500 block">åå·®</span>
                <span id="centsDiffResult" class="font-bold text-base">-</span>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æç¤º -->
    <div class="w-full max-w-lg text-center pb-4">
        <p class="text-xs text-slate-500">
            ğŸ’¡ ä½¿ç”¨æ­¥éª¤ï¼šæ’­æ”¾ç¤ºèŒƒéŸ³ â†’ æŒ‰ä½å½•éŸ³æ¨¡ä»¿ â†’ æ¾å¼€æŸ¥çœ‹ç»“æœ
        </p>
    </div>

    <script>
        // ==================== å…¨å±€çŠ¶æ€ ====================
        const NOTE_FREQUENCIES = {
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
            'C6': 1046.50
        };

        let currentTargetNote = null;
        let currentTargetFrequency = null;
        let selectedSoundType = 'triangle';
        let audioContext = null;
        let mediaStream = null;
        let audioRecorder = null;
        let recordedChunks = [];
        let isRecording = false;

        // è°ƒè¯•å‡½æ•°
        function debugLog(message) {
            const debugEl = document.getElementById('debugInfo');
            debugEl.textContent = message;
            debugEl.classList.remove('hidden');
            console.log('[Debug]', message);
        }

        // ==================== Canvas è®¾ç½® ====================
        const canvas = document.getElementById('targetCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            drawTarget(null);
        }

        window.addEventListener('resize', resizeCanvas);
        setTimeout(() => resizeCanvas(), 100);

        // ==================== ç»˜åˆ¶é¶å­ ====================
        function drawTarget(hitResult = null, isAnimating = false) {
            const width = canvas.getBoundingClientRect().width;
            const height = canvas.getBoundingClientRect().height;
            const centerX = width / 2;
            const centerY = height / 2;

            ctx.clearRect(0, 0, width, height);

            // èƒŒæ™¯
            ctx.fillStyle = '#F8FAFC';
            ctx.fillRect(0, 0, width, height);

            // é¶å­
            const targetRadius = Math.min(width, height) * 0.35;
            const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, targetRadius);
            gradient.addColorStop(0, '#FEF3C7');
            gradient.addColorStop(0.7, '#FDE68A');
            gradient.addColorStop(1, '#FCD34D');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(centerX, centerY, targetRadius, 0, Math.PI * 2);
            ctx.fill();

            // è¾¹ç¼˜
            ctx.strokeStyle = '#F59E0B';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(centerX, centerY, targetRadius, 0, Math.PI * 2);
            ctx.stroke();

            // å†…åœˆ
            ctx.strokeStyle = '#FBBF24';
            ctx.lineWidth = 2;
            [0.85, 0.7].forEach(scale => {
                ctx.beginPath();
                ctx.arc(centerX, centerY, targetRadius * scale, 0, Math.PI * 2);
                ctx.stroke();
            });

            // ä¸­å¿ƒçº¿
            ctx.strokeStyle = '#EF4444';
            ctx.lineWidth = 3;
            ctx.setLineDash([8, 8]);
            ctx.beginPath();
            ctx.moveTo(centerX - targetRadius - 30, centerY);
            ctx.lineTo(centerX + targetRadius + 30, centerY);
            ctx.stroke();
            ctx.setLineDash([]);

            // åˆ»åº¦
            const tickPositions = [-50, -30, -10, 0, 10, 30, 50];
            tickPositions.forEach(cents => {
                const y = centerY + (cents * 3);
                ctx.strokeStyle = cents === 0 ? '#EF4444' : '#6B7280';
                ctx.lineWidth = cents === 0 ? 3 : 2;
                ctx.beginPath();
                ctx.moveTo(centerX - 20, y);
                ctx.lineTo(centerX + 20, y);
                ctx.stroke();

                ctx.fillStyle = '#4B5563';
                ctx.font = 'bold 10px Inter';
                ctx.textAlign = 'right';
                const label = cents === 0 ? '0' : (cents > 0 ? `+${cents}` : cents);
                ctx.fillText(label, centerX - 28, y + 3);
            });

            // æ ‡ç­¾
            ctx.fillStyle = '#EF4444';
            ctx.font = 'bold 12px Nunito';
            ctx.textAlign = 'center';
            ctx.fillText('â†‘ é«˜éŸ³', centerX, centerY - targetRadius - 15);

            ctx.fillStyle = '#3B82F6';
            ctx.fillText('â†“ ä½éŸ³', centerX, centerY + targetRadius + 20);

            // é¶å¿ƒ
            const time = Date.now() / 1000;
            const pulseSize = isAnimating ? Math.sin(time * 3) * 3 : 0;

            ctx.fillStyle = '#EF4444';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8 + pulseSize, 0, Math.PI * 2);
            ctx.fill();

            ctx.strokeStyle = '#FEE2E2';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(centerX, centerY, 12 + pulseSize, 0, Math.PI * 2);
            ctx.stroke();

            if (hitResult !== null) {
                drawHitPoint(centerX, centerY, hitResult);
                drawArrow(centerX, centerY, hitResult);
            }
        }

        // ==================== ç»˜åˆ¶å‡»ä¸­ç‚¹ ====================
        function drawHitPoint(centerX, centerY, cents) {
            const clampedCents = Math.max(-100, Math.min(100, cents));
            const y = centerY + (clampedCents * 3);

            let color, radius, glowColor;
            if (Math.abs(cents) <= 10) {
                color = '#10B981';
                radius = 14;
                glowColor = 'rgba(16, 185, 129, 0.4)';
            } else if (Math.abs(cents) <= 30) {
                color = '#F59E0B';
                radius = 12;
                glowColor = 'rgba(245, 158, 11, 0.4)';
            } else {
                color = '#EF4444';
                radius = 10;
                glowColor = 'rgba(239, 68, 68, 0.4)';
            }

            for (let i = 3; i > 0; i--) {
                ctx.beginPath();
                ctx.arc(centerX, y, radius * (i + 1) * 0.8, 0, Math.PI * 2);
                ctx.fillStyle = glowColor;
                ctx.globalAlpha = 0.3 / i;
                ctx.fill();
            }
            ctx.globalAlpha = 1;

            ctx.beginPath();
            ctx.arc(centerX, y, radius, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();

            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 3;
            ctx.stroke();

            if (Math.abs(cents) <= 10) {
                drawStar(centerX + 30, y, 5, 8, 4);
                drawStar(centerX - 30, y, 5, 6, 3);
            }
        }

        // ==================== ç»˜åˆ¶ç®­å¤´ ====================
        function drawArrow(centerX, centerY, cents) {
            const clampedCents = Math.max(-100, Math.min(100, cents));
            const y = centerY + (clampedCents * 3);
            const arrowX = centerX - 50;
            const direction = cents > 0 ? -1 : 1;

            ctx.save();
            ctx.translate(arrowX, y);

            ctx.fillStyle = cents > 0 ? '#EF4444' : '#3B82F6';
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-12, direction * -8);
            ctx.lineTo(-12, direction * 8);
            ctx.closePath();
            ctx.fill();

            ctx.fillRect(-12, -2, 20, 4);

            ctx.beginPath();
            ctx.moveTo(8, 0);
            ctx.lineTo(0, direction * -6);
            ctx.lineTo(0, direction * 6);
            ctx.closePath();
            ctx.fill();

            ctx.restore();
        }

        // ==================== ç»˜åˆ¶æ˜Ÿæ˜Ÿ ====================
        function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
            let rot = -Math.PI / 2;
            let x = cx;
            let y = cy;
            const step = Math.PI / spikes;

            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);

            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius;
                y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y);
                rot += step;

                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y);
                rot += step;
            }

            ctx.lineTo(cx, cy - outerRadius);
            ctx.closePath();

            const gradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, outerRadius);
            gradient.addColorStop(0, '#FBBF24');
            gradient.addColorStop(1, '#F59E0B');
            ctx.fillStyle = gradient;
            ctx.fill();

            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        // ==================== æ’­æ”¾ç¤ºèŒƒéŸ³ ====================
        function getRandomNote() {
            const noteNames = Object.keys(NOTE_FREQUENCIES);
            const randomIndex = Math.floor(Math.random() * noteNames.length);
            const noteName = noteNames[randomIndex];
            return {
                name: noteName,
                frequency: NOTE_FREQUENCIES[noteName]
            };
        }

        async function playDemoTone() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    debugLog('AudioContext åˆ›å»ºæˆåŠŸ');
                }

                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                    debugLog('AudioContext å·²æ¢å¤');
                }

                const note = getRandomNote();
                currentTargetNote = note.name;
                currentTargetFrequency = note.frequency;

                document.getElementById('targetNoteDisplay').textContent = `${note.name} (${note.frequency.toFixed(0)} Hz)`;
                document.getElementById('targetNoteResult').textContent = `${note.name} (${note.frequency.toFixed(0)} Hz)`;

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = selectedSoundType === 'triangle' || selectedSoundType === 'piano' ? 'triangle' : 'sine';
                oscillator.frequency.value = currentTargetFrequency;
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.4, now + 0.05);
                gainNode.gain.linearRampToValueAtTime(0.35, now + 0.1);
                gainNode.gain.linearRampToValueAtTime(0.35, now + 1.5);
                gainNode.gain.linearRampToValueAtTime(0.2, now + 2);
                gainNode.gain.linearRampToValueAtTime(0, now + 2.5);

                oscillator.start(now);
                oscillator.stop(now + 2.5);

                let animating = true;
                const animate = () => {
                    if (!animating) return;
                    drawTarget(null, true);
                    requestAnimationFrame(animate);
                };
                animate();

                setTimeout(() => {
                    animating = false;
                    drawTarget(null, false);
                }, 2500);

            } catch (error) {
                debugLog('æ’­æ”¾é”™è¯¯: ' + error.message);
                console.error('Play error:', error);
            }
        }

        // ==================== å½•éŸ³æ¨¡å— - ä¿®å¤ç‰ˆ ====================
        async function startRecording() {
            try {
                debugLog('è¯·æ±‚éº¦å…‹é£æƒé™...');

                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                debugLog('éº¦å…‹é£æƒé™å·²è·å–');

                audioRecorder = new MediaRecorder(mediaStream);
                recordedChunks = [];

                audioRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                audioRecorder.start();
                isRecording = true;
                debugLog('å½•éŸ³å·²å¼€å§‹');

            } catch (error) {
                debugLog('éº¦å…‹é£é”™è¯¯: ' + error.message);
                console.error('Microphone error:', error);

                // å‹å¥½çš„é”™è¯¯æç¤º
                const statusEl = document.getElementById('recordingStatus');
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    statusEl.textContent = 'âŒ è¯·å…è®¸éº¦å…‹é£æƒé™';
                } else if (error.name === 'NotFoundError') {
                    statusEl.textContent = 'âŒ æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡';
                } else if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    statusEl.textContent = 'âŒ éœ€è¦ HTTPS åè®®';
                } else {
                    statusEl.textContent = 'âŒ éº¦å…‹é£è®¿é—®å¤±è´¥';
                }

                throw error;
            }
        }

        function stopRecording() {
            return new Promise((resolve) => {
                if (audioRecorder && audioRecorder.state !== 'inactive') {
                    audioRecorder.onstop = () => {
                        const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                        debugLog('å½•éŸ³å·²åœæ­¢ï¼Œå¤§å°: ' + audioBlob.size + ' bytes');
                        resolve(audioBlob);
                    };

                    audioRecorder.stop();
                    if (mediaStream) {
                        mediaStream.getTracks().forEach(track => track.stop());
                    }
                    isRecording = false;
                }
            });
        }

        async function getAudioDataFromBlob(blob) {
            const arrayBuffer = await blob.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            return audioBuffer.getChannelData(0);
        }

        // ==================== éŸ³é«˜æ£€æµ‹ ====================
        function autocorrelate(buffer, sampleRate) {
            const SIZE = buffer.length;
            const MAX_SAMPLES = Math.floor(SIZE / 2);
            let bestOffset = -1;
            let bestCorrelation = 0;
            let rms = 0;

            for (let i = 0; i < SIZE; i++) {
                rms += buffer[i] * buffer[i];
            }
            rms = Math.sqrt(rms / SIZE);

            if (rms < 0.01) return -1;

            let lastCorrelation = 1;
            let foundGoodCorrelation = false;

            for (let offset = 0; offset < MAX_SAMPLES; offset++) {
                let correlation = 0;

                for (let i = 0; i < MAX_SAMPLES; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - (correlation / MAX_SAMPLES);

                if (correlation > 0.9 && correlation > lastCorrelation) {
                    foundGoodCorrelation = true;
                    if (correlation > bestCorrelation) {
                        bestCorrelation = correlation;
                        bestOffset = offset;
                    }
                } else if (foundGoodCorrelation) {
                    return sampleRate / bestOffset;
                }
                lastCorrelation = correlation;
            }

            if (bestCorrelation > 0.01) {
                return sampleRate / bestOffset;
            }
            return -1;
        }

        function detectPitch(buffer) {
            const sampleRate = audioContext.sampleRate;
            const frequency = autocorrelate(buffer, sampleRate);

            if (frequency === -1 || frequency < 80 || frequency > 1200) {
                return null;
            }
            return frequency;
        }

        function calculateCentsDiff(userFreq, targetFreq) {
            return Math.round(1200 * Math.log2(userFreq / targetFreq));
        }

        function findClosestNote(frequency) {
            let closestNote = null;
            let minDiff = Infinity;

            for (const [note, freq] of Object.entries(NOTE_FREQUENCIES)) {
                const diff = Math.abs(frequency - freq);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestNote = { note, freq };
                }
            }

            return closestNote;
        }

        // ==================== æ˜¾ç¤ºç»“æœ ====================
        function showResult(centsDiff, userPitch) {
            drawTarget(centsDiff, false);

            const closestNote = findClosestNote(userPitch);
            document.getElementById('userPitchResult').textContent =
                `${closestNote.note} (${userPitch.toFixed(0)} Hz)`;

            const diffSpan = document.getElementById('centsDiffResult');
            if (Math.abs(centsDiff) <= 10) {
                diffSpan.textContent = `âœ¨ å®Œç¾å‘½ä¸­ Â±${Math.abs(centsDiff)}Â¢`;
                diffSpan.className = 'font-bold text-emerald-600';
            } else if (Math.abs(centsDiff) <= 30) {
                diffSpan.textContent = `${centsDiff > 0 ? 'â¬†ï¸' : 'â¬‡ï¸'} ${Math.abs(centsDiff)}Â¢`;
                diffSpan.className = 'font-bold text-amber-600';
            } else {
                diffSpan.textContent = `${centsDiff > 0 ? 'â¬†ï¸â¬†ï¸' : 'â¬‡ï¸â¬‡ï¸'} ${Math.abs(centsDiff)}Â¢`;
                diffSpan.className = 'font-bold text-red-600';
            }

            const resultOverlay = document.getElementById('resultOverlay');
            const resultIcon = document.getElementById('resultIcon');
            const resultText = document.getElementById('resultText');

            if (Math.abs(centsDiff) <= 10) {
                resultIcon.textContent = 'ğŸ¯';
                resultText.textContent = 'å®Œç¾å‘½ä¸­ï¼';
                resultText.className = 'text-xl font-bold text-emerald-600';
            } else if (Math.abs(centsDiff) <= 30) {
                resultIcon.textContent = centsDiff > 0 ? 'â¬†ï¸' : 'â¬‡ï¸';
                resultText.textContent = centsDiff > 0 ? 'ç¨å¾®åé«˜' : 'ç¨å¾®åä½';
                resultText.className = 'text-xl font-bold text-amber-600';
            } else {
                resultIcon.textContent = centsDiff > 0 ? 'â¬†ï¸â¬†ï¸' : 'â¬‡ï¸â¬‡ï¸';
                resultText.textContent = centsDiff > 0 ? 'åé«˜å¾ˆå¤š' : 'åä½å¾ˆå¤š';
                resultText.className = 'text-xl font-bold text-red-600';
            }

            resultOverlay.style.opacity = '1';
            setTimeout(() => {
                resultOverlay.style.opacity = '0';
            }, 2000);

            debugLog('æ£€æµ‹å®Œæˆ');
        }

        // ==================== äº‹ä»¶ç›‘å¬ - ä¿®å¤ç‰ˆ ====================
        const recordBtn = document.getElementById('recordBtn');
        const recordingStatus = document.getElementById('recordingStatus');

        // å¤„ç†å½•éŸ³å¼€å§‹
        async function handleStartRecording(e) {
            e.preventDefault();
            e.stopPropagation();

            if (!currentTargetFrequency) {
                recordingStatus.textContent = 'âš ï¸ è¯·å…ˆæ’­æ”¾ç¤ºèŒƒéŸ³';
                return;
            }

            if (isRecording) {
                debugLog('å·²åœ¨å½•éŸ³ä¸­ï¼Œå¿½ç•¥');
                return;
            }

            try {
                // éœ‡åŠ¨åé¦ˆ
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }

                recordBtn.classList.add('recording');
                recordingStatus.textContent = 'ğŸ¤ æ­£åœ¨å½•éŸ³... æ¾å¼€ç»“æŸ';

                await startRecording();

            } catch (error) {
                recordBtn.classList.remove('recording');
                recordingStatus.textContent = 'âŒ å½•éŸ³å¯åŠ¨å¤±è´¥';
            }
        }

        // å¤„ç†å½•éŸ³ç»“æŸ
        async function handleStopRecording(e) {
            e.preventDefault();
            e.stopPropagation();

            if (!isRecording) {
                debugLog('æœªåœ¨å½•éŸ³ä¸­ï¼Œå¿½ç•¥');
                return;
            }

            try {
                recordBtn.classList.remove('recording');
                recordingStatus.textContent = 'ğŸ“Š åˆ†æä¸­...';

                const audioBlob = await stopRecording();
                const audioData = await getAudioDataFromBlob(audioBlob);
                const userPitch = detectPitch(audioData);

                if (userPitch && currentTargetFrequency) {
                    const centsDiff = calculateCentsDiff(userPitch, currentTargetFrequency);
                    showResult(centsDiff, userPitch);
                    recordingStatus.textContent = 'âœ… å®Œæˆï¼å†è¯•ä¸€æ¬¡';
                } else {
                    recordingStatus.textContent = 'âŒ æ£€æµ‹å¤±è´¥ï¼Œè¯·é‡è¯•';
                }

            } catch (error) {
                debugLog('åœæ­¢å½•éŸ³é”™è¯¯: ' + error.message);
                recordingStatus.textContent = 'âŒ å¤„ç†å¤±è´¥';
            }
        }

        // è§¦æ‘¸äº‹ä»¶
        recordBtn.addEventListener('touchstart', handleStartRecording, { passive: false });
        recordBtn.addEventListener('touchend', handleStopRecording, { passive: false });
        recordBtn.addEventListener('touchcancel', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            if (isRecording) {
                await stopRecording();
                isRecording = false;
                recordBtn.classList.remove('recording');
                recordingStatus.textContent = 'âš ï¸ å½•éŸ³å·²å–æ¶ˆ';
            }
        }, { passive: false });

        // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢æµ‹è¯•ï¼‰
        recordBtn.addEventListener('mousedown', handleStartRecording);
        recordBtn.addEventListener('mouseup', handleStopRecording);
        recordBtn.addEventListener('mouseleave', async () => {
            if (isRecording) {
                await stopRecording();
                isRecording = false;
                recordBtn.classList.remove('recording');
                recordingStatus.textContent = 'âš ï¸ å½•éŸ³å·²å–æ¶ˆ';
            }
        });

        recordBtn.addEventListener('contextmenu', (e) => e.preventDefault());

        // å…¶ä»–æŒ‰é’®
        document.getElementById('playDemoBtn').addEventListener('click', () => {
            playDemoTone();
        });

        document.querySelectorAll('.sound-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.sound-btn').forEach(b => {
                    b.classList.remove('active');
                    b.classList.add('bg-slate-50', 'text-slate-700');
                });

                const targetBtn = e.currentTarget;
                targetBtn.classList.add('active');
                targetBtn.classList.remove('bg-slate-50', 'text-slate-700');
                selectedSoundType = targetBtn.dataset.sound;
            });
        });

        // ==================== åˆå§‹åŒ– ====================
        drawTarget(null, false);

        // æ£€æŸ¥ HTTPS
        if (location.protocol !== 'https:' &&
            location.hostname !== 'localhost' &&
            location.hostname !== '127.0.0.1' &&
            !location.hostname.startsWith('192.168.') &&
            !location.hostname.startsWith('10.')) {
            debugLog('è­¦å‘Š: éœ€è¦ HTTPS åè®®è®¿é—®éº¦å…‹é£');
            recordingStatus.textContent = 'âš ï¸ éº¦å…‹é£éœ€è¦ HTTPS';
        }

        // é¦–æ¬¡äº¤äº’åˆå§‹åŒ–
        const initAudio = async () => {
            if (audioContext && audioContext.state === 'suspended') {
                await audioContext.resume();
                debugLog('AudioContext å·²åˆå§‹åŒ–');
            }
        };

        document.addEventListener('touchstart', initAudio, { once: true });
        document.addEventListener('click', initAudio, { once: true });

        debugLog('åº”ç”¨å·²å°±ç»ª');
    </script>
</body>
</html>
