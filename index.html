<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéµ Èü≥ÂáÜËäÇÂ•èÊ∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        body {
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
        }
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn-sound {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-sound.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 0 15px rgba(245, 87, 108, 0.5);
        }
        .btn-start {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .level-select {
            display: flex;
            gap: 8px;
        }
        .btn-level {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-level.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-color: transparent;
        }
        .bottom-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        }
        .sing-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: 4px solid rgba(255,255,255,0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px rgba(238, 90, 36, 0.4);
        }
        .sing-btn:hover {
            transform: scale(1.05);
        }
        .sing-btn.singing {
            animation: sing-pulse 0.5s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.8);
        }
        @keyframes sing-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .sing-btn .icon {
            font-size: 36px;
        }
        .sing-btn .text {
            font-size: 12px;
            font-weight: 600;
            color: white;
            margin-top: 4px;
        }
        .game-info {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: white;
            z-index: 100;
        }
        .game-info .score {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .game-info .combo {
            font-size: 18px;
            color: #ffd700;
            font-weight: 600;
        }
        .game-info .hint {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-top: 4px;
        }
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .result-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .result-panel {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px 40px;
            text-align: center;
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        .result-overlay.show .result-panel {
            transform: scale(1);
        }
        .result-panel .emoji {
            font-size: 64px;
            margin-bottom: 16px;
        }
        .result-panel .title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .result-panel .subtitle {
            font-size: 16px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 20px;
        }
        .result-panel .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .result-panel .stat {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
        }
        .result-panel .stat-value {
            font-size: 24px;
            font-weight: 700;
        }
        .result-panel .stat-label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }
        .result-panel .btn-restart {
            padding: 14px 40px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }
        .pitch-indicator {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            z-index: 100;
        }
        .pitch-indicator .value {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
        }
        .pitch-indicator .label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            text-align: center;
            margin-top: 4px;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div class="top-bar">
        <div class="level-select">
            <button class="btn btn-level active" data-level="1">ÂÖ≥Âç°1</button>
            <button class="btn btn-level" data-level="2">ÂÖ≥Âç°2</button>
            <button class="btn btn-level" data-level="3">ÂÖ≥Âç°3</button>
        </div>
        <button class="btn btn-sound active" data-sound="triangle">üéπ ‰∏âËßíÊ≥¢</button>
        <button class="btn btn-sound" data-sound="sine">üéµ Ê≠£Âº¶Ê≥¢</button>
        <button class="btn btn-start" id="startBtn">‚ñ∂ ÂºÄÂßãÊ∏∏Êàè</button>
    </div>

    <div class="game-info">
        <div class="score" id="scoreDisplay">ÂæóÂàÜ: 0</div>
        <div class="combo" id="comboDisplay"></div>
        <div class="hint" id="hintDisplay">ÁÇπÂáª"ÂºÄÂßãÊ∏∏Êàè"ÂºÄÂßã</div>
    </div>

    <div class="pitch-indicator">
        <div class="value" id="pitchValue">--</div>
        <div class="label">ÂΩìÂâçÈü≥È´ò</div>
    </div>

    <div class="bottom-area">
        <div class="sing-btn" id="singBtn">
            <div class="icon">üé§</div>
            <div class="text">Êåâ‰ΩèÂèëÂ£∞</div>
        </div>
    </div>

    <div class="result-overlay" id="resultOverlay">
        <div class="result-panel">
            <div class="emoji" id="resultEmoji">üéØ</div>
            <div class="title" id="resultTitle">Ê∏∏ÊàèÁªìÊùü</div>
            <div class="subtitle" id="resultSubtitle">‰Ω†ÁöÑÈü≥ÂáÜËÆ≠ÁªÉÂÆåÊàê</div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" style="color: #4ade80;" id="statPerfect">0</div>
                    <div class="stat-label">ÂÆåÁæé</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #fbbf24;" id="statGood">0</div>
                    <div class="stat-label">Êé•Ëøë</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #f87171;" id="statMiss">0</div>
                    <div class="stat-label">ÂÅèÁ¶ª</div>
                </div>
            </div>
            <button class="btn-restart" id="restartBtn">ÂÜçÊù•‰∏ÄÊ¨°</button>
        </div>
    </div>

    <script>
        // ==================== Èü≥Á¨¶È¢ëÁéáË°® ====================
        const NOTE_FREQUENCIES = {
            'C3': 130.81, 'D3': 146.83, 'E3': 164.81, 'F3': 174.61, 'G3': 196.00, 'A3': 220.00, 'B3': 246.94,
            'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88,
            'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, 'A5': 880.00, 'B5': 987.77
        };

        // ==================== ÂÖ≥Âç°ÊóãÂæãÈÖçÁΩÆ ====================
        const LEVELS = {
            1: {
                name: 'ÂçïÈü≥ËÆ≠ÁªÉ',
                speed: 1.5,
                showNoteName: true,
                melodies: [
                    [{ note: 'C4', duration: 2000 }],
                    [{ note: 'E4', duration: 2000 }],
                    [{ note: 'G4', duration: 2000 }],
                    [{ note: 'A4', duration: 2000 }]
                ]
            },
            2: {
                name: 'Áõ∏ÈÇªÈü≥Èò∂',
                speed: 2.5,
                showNoteName: false,
                melodies: [
                    [
                        { note: 'C4', duration: 800 },
                        { note: 'D4', duration: 800 },
                        { note: 'E4', duration: 800 }
                    ],
                    [
                        { note: 'E4', duration: 800 },
                        { note: 'F4', duration: 800 },
                        { note: 'G4', duration: 800 }
                    ],
                    [
                        { note: 'G4', duration: 800 },
                        { note: 'A4', duration: 800 },
                        { note: 'G4', duration: 800 }
                    ]
                ]
            },
            3: {
                name: 'Áü≠ÊóãÂæã',
                speed: 3.5,
                showNoteName: false,
                melodies: [
                    [
                        { note: 'E4', duration: 600 },
                        { note: 'D4', duration: 600 },
                        { note: 'E4', duration: 600 },
                        { note: 'G4', duration: 800 }
                    ],
                    [
                        { note: 'C4', duration: 500 },
                        { note: 'E4', duration: 500 },
                        { note: 'G4', duration: 500 },
                        { note: 'C5', duration: 600 },
                        { note: 'G4', duration: 500 }
                    ],
                    [
                        { note: 'G4', duration: 500 },
                        { note: 'E4', duration: 500 },
                        { note: 'C4', duration: 500 },
                        { note: 'E4', duration: 500 },
                        { note: 'D4', duration: 800 },
                        { note: 'C4', duration: 600 }
                    ]
                ]
            }
        };

        // ==================== ÂÖ®Â±ÄÁä∂ÊÄÅ ====================
        let audioContext = null;
        let analyser = null;
        let mediaStream = null;
        let selectedSoundType = 'triangle';
        let currentLevel = 1;
        let gameRunning = false;
        let isSinging = false;

        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let stats = { perfect: 0, good: 0, miss: 0 };

        let currentMelody = [];
        let melodyIndex = 0;
        let gameNotes = [];      // ÊªöÂä®ÁöÑÈü≥Á¨¶
        let hitPoints = [];      // ÂëΩ‰∏≠ÁÇπ
        let missIndicators = []; // ÂÅèÁ¶ªÊåáÁ§∫Âô®
        let waveRings = [];      // Èü≥Êµ™ÁéØ

        let pitchHistory = [];
        const PITCH_SMOOTHING = 3;
        const CENTS_THRESHOLD = 30;  // ÂëΩ‰∏≠Âà§ÂÆöÔºö¬±30 cents
        const GOOD_CENTS_THRESHOLD = 50; // Êé•ËøëÂà§ÂÆö

        // ==================== Canvas ËÆæÁΩÆ ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let staff = {
            y: 0,
            lineSpacing: 20,
            numLines: 5,
            judgeX: 0
        };

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            ctx.scale(dpr, dpr);

            staff.y = window.innerHeight * 0.38;
            staff.lineSpacing = Math.min(25, window.innerHeight * 0.035);
            staff.judgeX = window.innerWidth * 0.3;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ==================== Èü≥È¢ëÁ≥ªÁªü ====================
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function playDemoTone(noteName, duration = 500) {
            return new Promise((resolve) => {
                initAudio();

                const freq = NOTE_FREQUENCIES[noteName];
                if (!freq) { resolve(); return; }

                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.type = selectedSoundType === 'triangle' ? 'triangle' : 'sine';
                osc.frequency.value = freq;

                osc.connect(gain);
                gain.connect(audioContext.destination);

                const now = audioContext.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.05);
                gain.gain.linearRampToValueAtTime(0.25, now + duration / 1000 - 0.1);
                gain.gain.linearRampToValueAtTime(0, now + duration / 1000);

                osc.start(now);
                osc.stop(now + duration / 1000);

                // Èü≥Êµ™ÊïàÊûú
                createWaveRings(duration / 1000);

                osc.onended = resolve;
            });
        }

        function createWaveRings(duration) {
            const startTime = Date.now();
            const interval = setInterval(() => {
                if (Date.now() - startTime > duration * 1000) {
                    clearInterval(interval);
                    return;
                }
                waveRings.push({
                    radius: staff.lineSpacing * 2.5,
                    maxRadius: staff.lineSpacing * 8,
                    opacity: 0.6,
                    phase: 0
                });
            }, 100);
        }

        // ==================== Èü≥È´òÊ£ÄÊµã ====================
        function autocorrelate(buffer, sampleRate) {
            const SIZE = buffer.length;
            const MAX_SAMPLES = Math.floor(SIZE / 2);
            let bestOffset = -1;
            let bestCorrelation = 0;
            let rms = 0;

            for (let i = 0; i < SIZE; i++) rms += buffer[i] * buffer[i];
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;

            let lastCorrelation = 1;
            let foundGoodCorrelation = false;

            for (let offset = 0; offset < MAX_SAMPLES; offset++) {
                let correlation = 0;
                for (let i = 0; i < MAX_SAMPLES; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - (correlation / MAX_SAMPLES);

                if (correlation > 0.9 && correlation > lastCorrelation) {
                    foundGoodCorrelation = true;
                    if (correlation > bestCorrelation) {
                        bestCorrelation = correlation;
                        bestOffset = offset;
                    }
                } else if (foundGoodCorrelation) {
                    return sampleRate / bestOffset;
                }
                lastCorrelation = correlation;
            }

            if (bestCorrelation > 0.01) return sampleRate / bestOffset;
            return -1;
        }

        function detectPitch(buffer) {
            const sampleRate = audioContext.sampleRate;
            const frequency = autocorrelate(buffer, sampleRate);
            if (frequency === -1 || frequency < 80 || frequency > 1200) return null;
            return frequency;
        }

        function calculateCentsDiff(userFreq, targetFreq) {
            return 1200 * Math.log2(userFreq / targetFreq);
        }

        function smoothPitch(pitch) {
            pitchHistory.push(pitch);
            if (pitchHistory.length > PITCH_SMOOTHING) {
                pitchHistory.shift();
            }
            return pitchHistory.reduce((a, b) => a + b, 0) / pitchHistory.length;
        }

        function frequencyToNoteName(freq) {
            let minDiff = Infinity;
            let closestNote = null;

            for (const [note, noteFreq] of Object.entries(NOTE_FREQUENCIES)) {
                const diff = Math.abs(freq - noteFreq);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestNote = note;
                }
            }
            return closestNote;
        }

        // ==================== ‰∫îÁ∫øË∞±Á≥ªÁªü ====================
        function noteToYPosition(noteName) {
            const noteOrder = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const note = noteName.slice(0, -1);
            const octave = parseInt(noteName.slice(-1));

            const baseLine = 4; // G4Âú®Á¨¨‰∫îÁ∫øÔºàÁ¥¢Âºï4Ôºâ
            const g4Index = noteOrder.indexOf('G');
            const currentIndex = noteOrder.indexOf(note);

            // C4Âú®Á¨¨‰∏ÄÈó¥‰∏ãÈù¢
            const c4Position = 2; // Áõ∏ÂØπ‰∫é‰∫îÁ∫øË∞±‰∏≠ÂøÉÁöÑÂÅèÁßª
            const noteOffset = currentIndex - noteOrder.indexOf('C');
            const octaveOffset = (octave - 4) * 7;

            const positionIndex = c4Position + noteOffset + octaveOffset;
            return staff.y - positionIndex * (staff.lineSpacing / 2);
        }

        function drawStaff() {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 1.5;

            // ÁªòÂà∂‰∫îÊù°Á∫ø
            for (let i = 0; i < staff.numLines; i++) {
                const y = staff.y + i * staff.lineSpacing;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(window.innerWidth, y);
                ctx.stroke();
            }

            // ÁªòÂà∂È´òÈü≥Ë∞±Âè∑ÔºàÁÆÄÂåñÔºâ
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = `${staff.lineSpacing * 5}px serif`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText('ùÑû', 20, staff.y + staff.lineSpacing * 1.5);

            // ÁªòÂà∂Âà§ÂÆöÁ∫ø
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.8)';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(staff.judgeX, staff.y - staff.lineSpacing * 3);
            ctx.lineTo(staff.judgeX, staff.y + staff.lineSpacing * 5);
            ctx.stroke();
            ctx.setLineDash([]);

            // Âà§ÂÆöÁ∫øÊ†áÁ≠æ
            ctx.fillStyle = 'rgba(255, 215, 0, 0.9)';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Âà§ÂÆöÁ∫ø', staff.judgeX, staff.y - staff.lineSpacing * 3.5);
        }

        // ==================== Èü≥Á¨¶Á±ª ====================
        class GameNote {
            constructor(noteName, duration, speed) {
                this.noteName = noteName;
                this.frequency = NOTE_FREQUENCIES[noteName];
                this.duration = duration;
                this.targetY = noteToYPosition(noteName);
                this.x = window.innerWidth + 100;
                this.speed = speed;
                this.hit = false;
                this.missed = false;
                this.demoPlayed = false;
            }

            update() {
                this.x -= this.speed;

                // Êí≠ÊîæÁ§∫ËåÉÈü≥
                if (!this.demoPlayed && this.x < staff.judgeX + 300) {
                    this.demoPlayed = true;
                    playDemoTone(this.noteName, Math.min(400, this.duration * 0.6));
                }

                // Ëá™Âä®ÈîôËøá
                if (this.x < staff.judgeX - 100 && !this.hit && !this.missed) {
                    this.missed = true;
                    stats.miss++;
                    combo = 0;
                    updateDisplay();
                }

                return this.x > -50;
            }

            draw() {
                const y = this.targetY;
                const size = staff.lineSpacing * 0.8;

                // Èü≥Á¨¶Â§¥
                ctx.fillStyle = this.hit ? '#4ade80' : (this.missed ? '#f87171' : '#60a5fa');
                ctx.beginPath();
                ctx.ellipse(this.x, y, size * 0.8, size * 0.6, 0, 0, Math.PI * 2);
                ctx.fill();

                // Èü≥Á¨¶ÊùÜ
                ctx.strokeStyle = ctx.fillStyle;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(this.x + size * 0.7, y);
                ctx.lineTo(this.x + size * 0.7, y - staff.lineSpacing * 3.5);
                ctx.stroke();

                // ÊòæÁ§∫Èü≥ÂêçÔºàÂÖ≥Âç°1Ôºâ
                if (LEVELS[currentLevel].showNoteName) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.font = 'bold 14px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(this.noteName, this.x, y - staff.lineSpacing * 4);
                }
            }
        }

        // ==================== ÂëΩ‰∏≠ÁÇπÁ±ª ====================
        class HitPoint {
            constructor(x, y, isPerfect) {
                this.x = x;
                this.y = y;
                this.isPerfect = isPerfect;
                this.scale = 0;
                this.opacity = 1;
            }

            update() {
                if (this.scale < 1) this.scale += 0.15;
                this.opacity -= 0.02;
                return this.opacity > 0;
            }

            draw() {
                const size = 12 * this.scale;
                const color = this.isPerfect ? '#4ade80' : '#fbbf24';

                // Â§ñÂúà
                ctx.strokeStyle = color;
                ctx.globalAlpha = this.opacity;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                ctx.stroke();

                // ÂÜÖÁÇπ
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, size * 0.5, 0, Math.PI * 2);
                ctx.fill();

                ctx.globalAlpha = 1;
            }
        }

        // ==================== ÂÅèÁ¶ªÊåáÁ§∫Âô®Á±ª ====================
        class MissIndicator {
            constructor(x, y, isHigh) {
                this.x = x;
                this.y = y;
                this.isHigh = isHigh;
                this.opacity = 1;
                this.offset = 0;
            }

            update() {
                this.offset += 2;
                this.opacity -= 0.015;
                return this.opacity > 0;
            }

            draw() {
                const indicatorY = this.isHigh ?
                    this.y - 30 - this.offset :
                    this.y + 30 + this.offset;

                ctx.fillStyle = `rgba(248, 113, 113, ${this.opacity})`;
                ctx.font = 'bold 16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(this.isHigh ? '‚Üì ÂÅèÈ´ò' : '‚Üë ÂÅè‰Ωé', this.x, indicatorY);

                // ÁÆ≠Â§¥
                ctx.beginPath();
                ctx.moveTo(this.x - 8, indicatorY + (this.isHigh ? 8 : -8));
                ctx.lineTo(this.x + 8, indicatorY + (this.isHigh ? 8 : -8));
                ctx.lineTo(this.x, indicatorY + (this.isHigh ? 18 : -18));
                ctx.closePath();
                ctx.fill();
            }
        }

        // ==================== Èü≥Êµ™ÁéØ ====================
        function drawWaveRings() {
            for (let i = waveRings.length - 1; i >= 0; i--) {
                const ring = waveRings[i];
                ring.radius += 2;
                ring.opacity -= 0.01;

                if (ring.opacity <= 0 || ring.radius > ring.maxRadius) {
                    waveRings.splice(i, 1);
                    continue;
                }

                ctx.strokeStyle = `rgba(139, 92, 246, ${ring.opacity})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(staff.judgeX, staff.y + staff.lineSpacing * 2, ring.radius, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        // ==================== Áî®Êà∑ÂèëÂ£∞ÁÆ≠Â§¥ ====================
        let arrows = [];
        let lastArrowTime = 0;
        const ARROW_INTERVAL = 100;

        class SingArrow {
            constructor(targetX, targetY, cents) {
                this.startX = window.innerWidth / 2;
                this.startY = window.innerHeight - 150;
                this.targetX = targetX;
                this.targetY = targetY;
                this.cents = cents;
                this.progress = 0;
                this.speed = 0.08;
            }

            update() {
                this.progress += this.speed;
                return this.progress < 1;
            }

            draw() {
                const x = this.startX + (this.targetX - this.startX) * this.progress;
                const y = this.startY + (this.targetY - this.startY) * this.progress;

                // Ê†πÊçÆcentsÂÜ≥ÂÆöÈ¢úËâ≤
                const absCents = Math.abs(this.cents);
                let color;
                if (absCents <= CENTS_THRESHOLD) color = '#4ade80';
                else if (absCents <= GOOD_CENTS_THRESHOLD) color = '#fbbf24';
                else color = '#f87171';

                // ÁªòÂà∂ÁÆ≠Â§¥
                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.lineWidth = 3;

                // ÁÆ≠Ë∫´
                ctx.beginPath();
                ctx.moveTo(this.startX, this.startY);
                ctx.lineTo(x, y);
                ctx.stroke();

                // ÁÆ≠Â§¥
                const angle = Math.atan2(this.targetY - this.startY, this.targetX - this.startX);
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(-15, -8);
                ctx.lineTo(-15, 8);
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }

        // ==================== Ê∏∏ÊàèÊéßÂà∂ ====================
        function startGame() {
            initAudio();

            const levelConfig = LEVELS[currentLevel];
            const melodyIndex = Math.floor(Math.random() * levelConfig.melodies.length);
            currentMelody = levelConfig.melodies[melodyIndex];

            gameNotes = [];
            hitPoints = [];
            missIndicators = [];
            arrows = [];
            waveRings = [];
            melodyIndex = 0;
            score = 0;
            combo = 0;
            maxCombo = 0;
            stats = { perfect: 0, good: 0, miss: 0 };

            gameRunning = true;
            updateDisplay();

            document.getElementById('hintDisplay').textContent = `ÂÖ≥Âç°${currentLevel}: ${levelConfig.name}`;

            // ÁîüÊàêÈü≥Á¨¶
            let delay = 0;
            currentMelody.forEach((noteData, index) => {
                setTimeout(() => {
                    if (gameRunning) {
                        gameNotes.push(new GameNote(noteData.note, noteData.duration, levelConfig.speed));
                    }
                }, delay);
                delay += noteData.duration + 500;
            });

            // Ê∏∏ÊàèÁªìÊùüÊ£ÄÊµã
            setTimeout(() => {
                if (gameRunning) {
                    endGame();
                }
            }, delay + 3000);
        }

        function endGame() {
            gameRunning = false;
            stopSinging();

            const overlay = document.getElementById('resultOverlay');
            const emoji = document.getElementById('resultEmoji');
            const title = document.getElementById('resultTitle');
            const subtitle = document.getElementById('resultSubtitle');

            const totalNotes = stats.perfect + stats.good + stats.miss;
            const accuracy = totalNotes > 0 ? Math.round((stats.perfect + stats.good) / totalNotes * 100) : 0;

            if (accuracy >= 90) {
                emoji.textContent = 'üèÜ';
                title.textContent = 'ÂÆåÁæéÔºÅ';
                subtitle.textContent = `ÂæóÂàÜ: ${score} | ÊúÄÈ´òËøûÂáª: ${maxCombo}`;
            } else if (accuracy >= 70) {
                emoji.textContent = 'üéØ';
                title.textContent = 'ÂæàÊ£íÔºÅ';
                subtitle.textContent = `ÂæóÂàÜ: ${score} | ÊúÄÈ´òËøûÂáª: ${maxCombo}`;
            } else if (accuracy >= 50) {
                emoji.textContent = 'üòä';
                title.textContent = 'ÁªßÁª≠Âä†Ê≤πÔºÅ';
                subtitle.textContent = `ÂæóÂàÜ: ${score} | ÊúÄÈ´òËøûÂáª: ${maxCombo}`;
            } else {
                emoji.textContent = 'üí™';
                title.textContent = 'Â§öÁªÉ‰π†Âì¶ÔºÅ';
                subtitle.textContent = `ÂæóÂàÜ: ${score} | ÂáÜÁ°ÆÁéá: ${accuracy}%`;
            }

            document.getElementById('statPerfect').textContent = stats.perfect;
            document.getElementById('statGood').textContent = stats.good;
            document.getElementById('statMiss').textContent = stats.miss;

            overlay.classList.add('show');
        }

        function updateDisplay() {
            document.getElementById('scoreDisplay').textContent = `ÂæóÂàÜ: ${score}`;
            document.getElementById('comboDisplay').textContent = combo > 1 ? `ËøûÂáª x${combo}` : '';
        }

        // ==================== ÂèëÂ£∞Ê£ÄÊµã ====================
        async function startSinging() {
            if (!gameRunning) return;

            try {
                initAudio();

                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);

                isSinging = true;
                pitchHistory = [];

                document.getElementById('singBtn').classList.add('singing');
                document.getElementById('singBtn').querySelector('.text').textContent = 'ÂèëÂ£∞‰∏≠...';

                detectPitchLoop();

            } catch (error) {
                console.error('Microphone error:', error);
                alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é');
            }
        }

        function stopSinging() {
            isSinging = false;
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }

            document.getElementById('singBtn').classList.remove('singing');
            document.getElementById('singBtn').querySelector('.text').textContent = 'Êåâ‰ΩèÂèëÂ£∞';
            document.getElementById('pitchValue').textContent = '--';
        }

        function detectPitchLoop() {
            if (!isSinging || !analyser) return;

            const bufferLength = analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(buffer);

            const pitch = detectPitch(buffer);

            if (pitch) {
                const smoothedPitch = smoothPitch(pitch);
                const noteName = frequencyToNoteName(smoothedPitch);

                document.getElementById('pitchValue').textContent = noteName || '--';

                // Ê£ÄÊü•ÊòØÂê¶ÂëΩ‰∏≠Âà§ÂÆöÁ∫ø‰∏äÁöÑÈü≥Á¨¶
                const activeNote = gameNotes.find(n =>
                    !n.hit && !n.missed &&
                    Math.abs(n.x - staff.judgeX) < 80
                );

                if (activeNote) {
                    const centsDiff = calculateCentsDiff(smoothedPitch, activeNote.frequency);
                    const absCents = Math.abs(centsDiff);

                    // ÁîüÊàêÁÆ≠Â§¥ËßÜËßâÊïàÊûú
                    const now = Date.now();
                    if (now - lastArrowTime > ARROW_INTERVAL) {
                        arrows.push(new SingArrow(
                            staff.judgeX,
                            activeNote.targetY,
                            centsDiff
                        ));
                        lastArrowTime = now;

                        // Èü≥Êµ™ÊïàÊûú
                        waveRings.push({
                            radius: staff.lineSpacing * 2,
                            maxRadius: staff.lineSpacing * 6,
                            opacity: 0.4,
                            phase: 0
                        });
                    }

                    // Âà§ÂÆöÂëΩ‰∏≠
                    if (absCents <= CENTS_THRESHOLD) {
                        activeNote.hit = true;
                        stats.perfect++;
                        score += 100 + combo * 10;
                        combo++;
                        maxCombo = Math.max(maxCombo, combo);
                        hitPoints.push(new HitPoint(staff.judgeX, activeNote.targetY, true));
                    } else if (absCents <= GOOD_CENTS_THRESHOLD) {
                        activeNote.hit = true;
                        stats.good++;
                        score += 50 + combo * 5;
                        combo++;
                        maxCombo = Math.max(maxCombo, combo);
                        hitPoints.push(new HitPoint(staff.judgeX, activeNote.targetY, false));
                    }
                }

                updateDisplay();
            }

            requestAnimationFrame(detectPitchLoop);
        }

        // ==================== Ê∏∏Êàè‰∏ªÂæ™ÁéØ ====================
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ÁªòÂà∂‰∫îÁ∫øË∞±
            drawStaff();

            // Èü≥Êµ™ÁéØ
            drawWaveRings();

            // Êõ¥Êñ∞ÂíåÁªòÂà∂Èü≥Á¨¶
            for (let i = gameNotes.length - 1; i >= 0; i--) {
                if (!gameNotes[i].update()) {
                    gameNotes.splice(i, 1);
                } else {
                    gameNotes[i].draw();
                }
            }

            // Êõ¥Êñ∞ÂíåÁªòÂà∂ÂëΩ‰∏≠ÁÇπ
            for (let i = hitPoints.length - 1; i >= 0; i--) {
                if (!hitPoints[i].update()) {
                    hitPoints.splice(i, 1);
                } else {
                    hitPoints[i].draw();
                }
            }

            // Êõ¥Êñ∞ÂíåÁªòÂà∂ÂÅèÁ¶ªÊåáÁ§∫Âô®
            for (let i = missIndicators.length - 1; i >= 0; i--) {
                if (!missIndicators[i].update()) {
                    missIndicators.splice(i, 1);
                } else {
                    missIndicators[i].draw();
                }
            }

            // Êõ¥Êñ∞ÂíåÁªòÂà∂ÁÆ≠Â§¥
            for (let i = arrows.length - 1; i >= 0; i--) {
                if (!arrows[i].update()) {
                    arrows.splice(i, 1);
                } else {
                    arrows[i].draw();
                }
            }

            requestAnimationFrame(gameLoop);
        }

        // ==================== ‰∫ã‰ª∂ÁªëÂÆö ====================
        document.getElementById('startBtn').addEventListener('click', startGame);

        const singBtn = document.getElementById('singBtn');
        singBtn.addEventListener('mousedown', startSinging);
        singBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startSinging(); });

        const stopHandler = () => { if (isSinging) stopSinging(); };
        document.addEventListener('mouseup', stopHandler);
        document.addEventListener('touchend', stopHandler);
        document.addEventListener('mouseleave', stopHandler);

        document.querySelectorAll('.btn-level').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.btn-level').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentLevel = parseInt(btn.dataset.level);
            });
        });

        document.querySelectorAll('.btn-sound').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.btn-sound').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedSoundType = btn.dataset.sound;
            });
        });

        document.getElementById('restartBtn').addEventListener('click', () => {
            document.getElementById('resultOverlay').classList.remove('show');
            startGame();
        });

        // ÂêØÂä®Ê∏∏ÊàèÂæ™ÁéØ
        gameLoop();

        // ÂàùÂßãÂåñÈü≥È¢ë
        document.addEventListener('click', () => {
            initAudio();
        }, { once: true });
    </script>
</body>
</html>
