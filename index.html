<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¯ éŸ³é«˜å°„é¶ - å…¨å±äº’åŠ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        body {
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .sound-btn {
            transition: all 0.2s ease;
        }
        .sound-btn:hover {
            transform: scale(1.05);
        }
        .sound-btn.active {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.6);
            transform: scale(1.1);
        }
        .result-popup {
            animation: popup-in 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes popup-in {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">

    <canvas id="gameCanvas"></canvas>

    <div id="header" class="fixed top-0 left-0 right-0 text-center py-4 pointer-events-none">
        <h1 class="text-3xl font-extrabold bg-gradient-to-r from-amber-400 via-orange-500 to-red-500 bg-clip-text text-transparent">
            ğŸ¯ éŸ³é«˜å°„é¶
        </h1>
        <p id="targetNoteDisplay" class="text-slate-400 text-sm mt-1">ç‚¹å‡»æ’­æ”¾ç›®æ ‡éŸ³ â†’ æŒ‰ä½å°äººå°„å‡»</p>
    </div>

    <div id="soundControls" class="fixed right-4 top-1/2 -translate-y-1/2 flex flex-col gap-2">
        <button class="sound-btn active w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold text-xs shadow-lg" data-sound="triangle">
            ğŸ¹
        </button>
        <button class="sound-btn w-12 h-12 rounded-full bg-gradient-to-br from-slate-600 to-slate-700 text-white font-bold text-xs shadow-lg" data-sound="sine">
            ğŸµ
        </button>
        <button class="sound-btn w-12 h-12 rounded-full bg-gradient-to-br from-slate-600 to-slate-700 text-white font-bold text-xs shadow-lg" data-sound="piano">
            ğŸ¼
        </button>
        <button class="sound-btn w-12 h-12 rounded-full bg-gradient-to-br from-slate-600 to-slate-700 text-white font-bold text-xs shadow-lg" data-sound="voice">
            ğŸ¤
        </button>
    </div>

    <div id="playTargetBtn" class="fixed left-4 top-1/2 -translate-y-1/2 px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl shadow-lg cursor-pointer pointer-events-auto hover:scale-105 transition-transform">
        â–¶ æ’­æ”¾ç›®æ ‡éŸ³
    </div>

    <div id="resultPopup" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-900/95 rounded-2xl p-8 shadow-2xl border border-slate-600 hidden result-popup z-50">
        <div id="resultIcon" class="text-6xl mb-4 text-center"></div>
        <p id="resultTitle" class="text-3xl font-bold text-center mb-2"></p>
        <p id="resultDetail" class="text-slate-400 text-center mb-4"></p>
        <div id="resultStats" class="grid grid-cols-3 gap-4 text-center text-sm">
            <div class="bg-slate-800 rounded-lg p-3">
                <div class="text-emerald-400 font-bold" id="statPerfect">0</div>
                <div class="text-slate-500">å®Œç¾</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-3">
                <div class="text-amber-400 font-bold" id="statClose">0</div>
                <div class="text-slate-500">æ¥è¿‘</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-3">
                <div class="text-red-400 font-bold" id="statOff">0</div>
                <div class="text-slate-500">åç¦»</div>
            </div>
        </div>
        <button id="closeResult" class="w-full mt-4 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-xl">
            å†æ¥ä¸€å±€
        </button>
    </div>

    <script>
        const NOTE_FREQUENCIES = {
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
            'C6': 1046.50
        };

        let audioContext = null;
        let analyser = null;
        let mediaStream = null;
        let currentTargetFrequency = null;
        let currentTargetNote = null;
        let selectedSoundType = 'triangle';
        let isRecording = false;
        let isDemoPlaying = false;

        const arrows = [];
        const landedPoints = [];
        const PITCH_SMOOTHING = 3;
        let pitchHistory = [];
        let lastArrowTime = 0;
        const ARROW_INTERVAL = 150;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let launcher = {
            x: 100,
            y: 0,
            radius: 50,
            isPressed: false,
            pulsePhase: 0
        };

        let target = {
            x: 0,
            y: 0,
            radius: 150,
            pulsePhase: 0
        };

        function resizeCanvas() {
            canvas.width = window.innerWidth * window.devicePixelRatio;
            canvas.height = window.innerHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

            launcher.x = Math.max(100, window.innerWidth * 0.15);
            launcher.y = window.innerHeight - 100;

            target.x = window.innerWidth * 0.7;
            target.y = window.innerHeight * 0.4;
            target.radius = Math.min(180, window.innerHeight * 0.25);
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function getRandomNote() {
            const noteNames = Object.keys(NOTE_FREQUENCIES);
            const randomIndex = Math.floor(Math.random() * noteNames.length);
            const noteName = noteNames[randomIndex];
            return { name: noteName, frequency: NOTE_FREQUENCIES[noteName] };
        }

        async function playDemoTone() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                const note = getRandomNote();
                currentTargetNote = note.name;
                currentTargetFrequency = note.frequency;

                document.getElementById('targetNoteDisplay').textContent = `ç›®æ ‡: ${note.name} (${note.frequency.toFixed(0)}Hz)`;

                isDemoPlaying = true;

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = selectedSoundType === 'triangle' || selectedSoundType === 'piano' ? 'triangle' : 'sine';
                oscillator.frequency.value = currentTargetFrequency;
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.35, now + 0.05);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.9);
                gainNode.gain.linearRampToValueAtTime(0, now + 1);

                oscillator.start(now);
                oscillator.stop(now + 1);

                oscillator.onended = () => {
                    isDemoPlaying = false;
                };

            } catch (error) {
                console.error('Play error:', error);
            }
        }

        function autocorrelate(buffer, sampleRate) {
            const SIZE = buffer.length;
            const MAX_SAMPLES = Math.floor(SIZE / 2);
            let bestOffset = -1;
            let bestCorrelation = 0;
            let rms = 0;

            for (let i = 0; i < SIZE; i++) rms += buffer[i] * buffer[i];
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;

            let lastCorrelation = 1;
            let foundGoodCorrelation = false;

            for (let offset = 0; offset < MAX_SAMPLES; offset++) {
                let correlation = 0;
                for (let i = 0; i < MAX_SAMPLES; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - (correlation / MAX_SAMPLES);

                if (correlation > 0.9 && correlation > lastCorrelation) {
                    foundGoodCorrelation = true;
                    if (correlation > bestCorrelation) {
                        bestCorrelation = correlation;
                        bestOffset = offset;
                    }
                } else if (foundGoodCorrelation) {
                    return sampleRate / bestOffset;
                }
                lastCorrelation = correlation;
            }

            if (bestCorrelation > 0.01) return sampleRate / bestOffset;
            return -1;
        }

        function detectPitch(buffer) {
            const sampleRate = audioContext.sampleRate;
            const frequency = autocorrelate(buffer, sampleRate);
            if (frequency === -1 || frequency < 80 || frequency > 1200) return null;
            return frequency;
        }

        function calculateCentsDiff(userFreq, targetFreq) {
            return Math.round(1200 * Math.log2(userFreq / targetFreq));
        }

        function smoothPitch(pitch) {
            pitchHistory.push(pitch);
            if (pitchHistory.length > PITCH_SMOOTHING) {
                pitchHistory.shift();
            }
            const sum = pitchHistory.reduce((a, b) => a + b, 0);
            return sum / pitchHistory.length;
        }

        function getCentsColor(cents) {
            if (Math.abs(cents) <= 10) return '#10B981';
            if (Math.abs(cents) <= 30) return '#F59E0B';
            return '#EF4444';
        }

        function getCentsCategory(cents) {
            if (Math.abs(cents) <= 10) return 'perfect';
            if (Math.abs(cents) <= 30) return 'close';
            return 'off';
        }

        class Arrow {
            constructor(x, y, targetX, targetY, cents) {
                this.x = x;
                this.y = y;
                this.targetX = targetX;
                this.targetY = targetY;
                this.cents = cents;
                this.color = getCentsColor(cents);
                this.progress = 0;
                this.speed = 0.03;
                this.landed = false;
                this.trail = [];
            }

            update() {
                if (this.landed) return;

                this.progress += this.speed;
                this.trail.push({ x: this.x, y: this.y });
                if (this.trail.length > 15) this.trail.shift();

                this.x += (this.targetX - this.x) * this.speed;
                this.y += (this.targetY - this.y) * this.speed;

                if (this.progress >= 1 || Math.abs(this.x - this.targetX) < 5) {
                    this.landed = true;
                    this.x = this.targetX;
                    this.y = this.targetY;
                    landedPoints.push({
                        x: this.x,
                        y: this.y,
                        cents: this.cents,
                        color: this.color,
                        category: getCentsCategory(this.cents)
                    });
                }
            }

            draw(ctx) {
                if (this.landed) return;

                if (this.trail.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(this.trail[0].x, this.trail[0].y);
                    for (let i = 1; i < this.trail.length; i++) {
                        ctx.lineTo(this.trail[i].x, this.trail[i].y);
                    }
                    ctx.lineTo(this.x, this.y);

                    const gradient = ctx.createLinearGradient(
                        this.trail[0].x, this.trail[0].y,
                        this.x, this.y
                    );
                    gradient.addColorStop(0, 'rgba(245, 158, 11, 0)');
                    gradient.addColorStop(1, this.color);
                    ctx.strokeStyle = gradient;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                ctx.save();
                ctx.translate(this.x, this.y);

                const angle = Math.atan2(this.targetY - this.y, this.targetX - this.x);
                ctx.rotate(angle);

                ctx.fillStyle = '#92400e';
                ctx.fillRect(-30, -2, 30, 4);

                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(-8, -5);
                ctx.lineTo(-8, 5);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#F59E0B';
                for (let i = 0; i < 3; i++) {
                    ctx.fillRect(-32, -3 + i * 3, 6, 1.5);
                }

                ctx.restore();
            }
        }

        async function startRecording() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);

                isRecording = true;
                pitchHistory = [];
                lastArrowTime = Date.now();

                detectPitchLoop();

            } catch (error) {
                console.error('Microphone error:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }

        function stopRecording() {
            isRecording = false;
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            showResult();
        }

        function detectPitchLoop() {
            if (!isRecording) return;

            const bufferLength = analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(buffer);

            const pitch = detectPitch(buffer);
            if (pitch && currentTargetFrequency) {
                const smoothedPitch = smoothPitch(pitch);
                const centsDiff = calculateCentsDiff(smoothedPitch, currentTargetFrequency);

                const now = Date.now();
                if (now - lastArrowTime >= ARROW_INTERVAL) {
                    const angle = (Math.random() - 0.5) * 0.3;
                    const targetY = target.y + (centsDiff * 3);
                    const arrow = new Arrow(
                        launcher.x + Math.cos(angle) * launcher.radius * 0.8,
                        launcher.y + Math.sin(angle) * launcher.radius * 0.8,
                        target.x + (Math.random() - 0.5) * target.radius * 0.6,
                        targetY,
                        centsDiff
                    );
                    arrows.push(arrow);
                    lastArrowTime = now;
                }
            }

            requestAnimationFrame(detectPitchLoop);
        }

        function showResult() {
            if (landedPoints.length === 0) {
                document.getElementById('resultIcon').textContent = 'ğŸ˜¶';
                document.getElementById('resultTitle').textContent = 'æœªæ£€æµ‹åˆ°å£°éŸ³';
                document.getElementById('resultTitle').className = 'text-3xl font-bold text-center mb-2 text-slate-400';
                document.getElementById('resultDetail').textContent = 'è¯·ç¡®ä¿å·²æ’­æ”¾ç›®æ ‡éŸ³å¹¶å‘å‡ºå£°éŸ³';
                document.getElementById('resultStats').classList.add('hidden');
            } else {
                const avgCents = landedPoints.reduce((sum, p) => sum + p.cents, 0) / landedPoints.length;
                const perfect = landedPoints.filter(p => p.category === 'perfect').length;
                const close = landedPoints.filter(p => p.category === 'close').length;
                const off = landedPoints.filter(p => p.category === 'off').length;

                if (Math.abs(avgCents) <= 15) {
                    document.getElementById('resultIcon').textContent = 'ğŸ¯';
                    document.getElementById('resultTitle').textContent = 'å®Œç¾å‘½ä¸­ï¼';
                    document.getElementById('resultTitle').className = 'text-3xl font-bold text-center mb-2 text-emerald-400';
                } else if (Math.abs(avgCents) <= 40) {
                    document.getElementById('resultIcon').textContent = avgCents > 0 ? 'â¬†ï¸' : 'â¬‡ï¸';
                    document.getElementById('resultTitle').textContent = avgCents > 0 ? 'ç¨å¾®åé«˜' : 'ç¨å¾®åä½';
                    document.getElementById('resultTitle').className = 'text-3xl font-bold text-center mb-2 text-amber-400';
                } else {
                    document.getElementById('resultIcon').textContent = avgCents > 0 ? 'â¬†ï¸â¬†ï¸' : 'â¬‡ï¸â¬‡ï¸';
                    document.getElementById('resultTitle').textContent = avgCents > 0 ? 'åé«˜å¾ˆå¤š' : 'åä½å¾ˆå¤š';
                    document.getElementById('resultTitle').className = 'text-3xl font-bold text-center mb-2 text-red-400';
                }

                document.getElementById('resultDetail').textContent = `å¹³å‡åå·® ${Math.abs(avgCents).toFixed(1)}Â¢ | å…±å‘å°„ ${landedPoints.length} æ”¯ç®­`;
                document.getElementById('statPerfect').textContent = perfect;
                document.getElementById('statClose').textContent = close;
                document.getElementById('statOff').textContent = off;
                document.getElementById('resultStats').classList.remove('hidden');
            }

            document.getElementById('resultPopup').classList.remove('hidden');
        }

        function drawLauncher() {
            const pulse = isRecording ? Math.sin(Date.now() / 100) * 5 : 0;
            const radius = launcher.radius + pulse;

            const gradient = ctx.createRadialGradient(
                launcher.x, launcher.y, 0,
                launcher.x, launcher.y, radius
            );

            if (isRecording) {
                gradient.addColorStop(0, '#F87171');
                gradient.addColorStop(0.7, '#DC2626');
                gradient.addColorStop(1, 'rgba(220, 38, 38, 0.3)');
            } else {
                gradient.addColorStop(0, '#60A5FA');
                gradient.addColorStop(0.7, '#3B82F6');
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.3)');
            }

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(launcher.x, launcher.y, radius, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#FFF';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ğŸ˜®', launcher.x, launcher.y - 5);

            ctx.fillStyle = isRecording ? '#FCA5A5' : '#93C5FD';
            ctx.font = 'bold 12px Arial';
            ctx.fillText(isRecording ? 'å½•éŸ³ä¸­...' : 'æŒ‰ä½å°„å‡»', launcher.x, launcher.y + 20);

            if (!isRecording) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.font = '11px Arial';
                ctx.fillText('â† æŒ‰ä½æˆ‘', launcher.x - 50, launcher.y + 35);
            }
        }

        function drawTarget() {
            const pulse = isDemoPlaying ? Math.sin(Date.now() / 150) * 8 : 0;
            const radius = target.radius + pulse;

            ctx.save();
            ctx.translate(target.x, target.y);

            for (let i = 5; i > 0; i--) {
                const r = radius * (i / 5);
                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, r);

                if (i === 1) {
                    gradient.addColorStop(0, 'rgba(239, 68, 68, 0.9)');
                    gradient.addColorStop(1, 'rgba(239, 68, 68, 0.6)');
                } else {
                    gradient.addColorStop(0, 'rgba(251, 191, 36, 0.3)');
                    gradient.addColorStop(1, 'rgba(245, 158, 11, 0.1)');
                }

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(0, 0, r, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = i === 1 ? '#EF4444' : '#F59E0B';
                ctx.lineWidth = i === 1 ? 3 : 2;
                ctx.stroke();
            }

            ctx.fillStyle = '#EF4444';
            ctx.beginPath();
            ctx.arc(0, 0, 15, 0, Math.PI * 2);
            ctx.fill();

            if (isDemoPlaying) {
                ctx.strokeStyle = '#FCD34D';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(0, 0, 25, 0, Math.PI * 2);
                ctx.stroke();
            }

            ctx.restore();

            for (const point of landedPoints) {
                ctx.fillStyle = point.color;
                ctx.beginPath();
                ctx.arc(point.x, point.y, 6, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        function drawLandedPoints() {
            for (const point of landedPoints) {
                const gradient = ctx.createRadialGradient(
                    point.x, point.y, 0,
                    point.x, point.y, 8
                );
                gradient.addColorStop(0, point.color);
                gradient.addColorStop(1, point.color + '40');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(point.x, point.y, 8, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.arc(point.x, point.y, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            drawTarget();
            drawLandedPoints();

            for (let i = arrows.length - 1; i >= 0; i--) {
                arrows[i].update();
                arrows[i].draw(ctx);
                if (arrows[i].landed) {
                    arrows.splice(i, 1);
                }
            }

            drawLauncher();

            requestAnimationFrame(gameLoop);
        }

        canvas.addEventListener('mousedown', handlePointerDown);
        canvas.addEventListener('touchstart', handlePointerDown, { passive: false });
        canvas.addEventListener('mouseup', handlePointerUp);
        canvas.addEventListener('touchend', handlePointerUp);
        canvas.addEventListener('mouseleave', handlePointerUp);
        canvas.addEventListener('touchcancel', handlePointerUp);

        function handlePointerDown(e) {
            e.preventDefault();

            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;

            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const x = clientX - rect.left;
            const y = clientY - rect.top;
            const dist = Math.sqrt((x - launcher.x) ** 2 + (y - launcher.y) ** 2);

            if (dist < launcher.radius * 1.2) {
                launcher.isPressed = true;

                if (!currentTargetFrequency) {
                    alert('è¯·å…ˆæ’­æ”¾ç›®æ ‡éŸ³ï¼');
                    return;
                }

                if (!isRecording) {
                    startRecording();
                }

                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }
        }

        function handlePointerUp(e) {
            if (launcher.isPressed && isRecording) {
                launcher.isPressed = false;
                stopRecording();
            }
        }

        document.getElementById('playTargetBtn').addEventListener('click', playDemoTone);

        document.querySelectorAll('.sound-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.sound-btn').forEach(b => {
                    b.classList.remove('active');
                    b.classList.remove('from-indigo-500', 'to-purple-600');
                    b.classList.add('from-slate-600', 'to-slate-700');
                });

                const targetBtn = e.currentTarget;
                targetBtn.classList.add('active');
                targetBtn.classList.remove('from-slate-600', 'to-slate-700');
                targetBtn.classList.add('from-indigo-500', 'to-purple-600');
                selectedSoundType = targetBtn.dataset.sound;
            });
        });

        document.getElementById('closeResult').addEventListener('click', () => {
            document.getElementById('resultPopup').classList.add('hidden');
            landedPoints.length = 0;
            arrows.length = 0;
            currentTargetFrequency = null;
            document.getElementById('targetNoteDisplay').textContent = 'ç‚¹å‡»æ’­æ”¾ç›®æ ‡éŸ³ â†’ æŒ‰ä½å°äººå°„å‡»';
        });

        resizeCanvas();
        gameLoop();

        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        document.addEventListener('click', async () => {
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
        }, { once: true });
    </script>
</body>
</html>
