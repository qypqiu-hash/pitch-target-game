<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéµ Èü≥ÂáÜËäÇÂ•èÊ∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }
        body {
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
        }
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn-sound {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-sound.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 0 15px rgba(245, 87, 108, 0.5);
        }
        .level-select {
            display: flex;
            gap: 8px;
        }
        .btn-level {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-level.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-color: transparent;
        }
        .bottom-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        }
        .main-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: 5px solid rgba(255,255,255,0.4);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 30px rgba(79, 172, 254, 0.5);
        }
        .main-btn:hover {
            transform: scale(1.05);
        }
        .main-btn.demo-mode {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 30px rgba(245, 87, 108, 0.5);
            animation: demo-pulse 2s ease-in-out infinite;
        }
        .main-btn.sing-mode {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 4px 30px rgba(238, 90, 36, 0.5);
        }
        .main-btn.singing {
            animation: sing-pulse 0.5s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(255, 107, 107, 0.8);
        }
        @keyframes demo-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes sing-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .main-btn .icon {
            font-size: 40px;
        }
        .main-btn .text {
            font-size: 13px;
            font-weight: 600;
            color: white;
            margin-top: 6px;
        }
        .game-info {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: white;
            z-index: 100;
        }
        .game-info .mode {
            font-size: 16px;
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: 4px;
        }
        .game-info .score {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .game-info .combo {
            font-size: 18px;
            color: #ffd700;
            font-weight: 600;
        }
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .result-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .result-panel {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px 40px;
            text-align: center;
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
            transform: scale(0.8);
            transition: transform 0.3s ease;
            max-width: 400px;
        }
        .result-overlay.show .result-panel {
            transform: scale(1);
        }
        .result-panel .emoji {
            font-size: 64px;
            margin-bottom: 16px;
        }
        .result-panel .title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .result-panel .subtitle {
            font-size: 16px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 20px;
        }
        .result-panel .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .result-panel .stat {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
        }
        .result-panel .stat-value {
            font-size: 24px;
            font-weight: 700;
        }
        .result-panel .stat-label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }
        .result-panel .btn-restart {
            padding: 14px 40px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }
        .pitch-indicator {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            z-index: 100;
        }
        .pitch-indicator .value {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
        }
        .pitch-indicator .label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            text-align: center;
            margin-top: 4px;
        }
        .mode-indicator {
            position: fixed;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            z-index: 100;
        }
        .mode-indicator .round {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
        }
        .mode-indicator .label {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            text-align: center;
            margin-top: 4px;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div class="top-bar">
        <div class="level-select">
            <button class="btn btn-level active" data-level="1">ÂÖ≥Âç°1</button>
            <button class="btn btn-level" data-level="2">ÂÖ≥Âç°2</button>
            <button class="btn btn-level" data-level="3">ÂÖ≥Âç°3</button>
        </div>
        <button class="btn btn-sound active" data-sound="triangle">üéπ ‰∏âËßíÊ≥¢</button>
        <button class="btn btn-sound" data-sound="sine">üéµ Ê≠£Âº¶Ê≥¢</button>
        <button class="btn" id="stopBtn" style="background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);">‚èπ ÂÅúÊ≠¢</button>
    </div>

    <div class="game-info">
        <div class="mode" id="modeDisplay">ÂáÜÂ§áÂºÄÂßã</div>
        <div class="score" id="scoreDisplay">ÂæóÂàÜ: 0</div>
        <div class="combo" id="comboDisplay"></div>
    </div>

    <div class="mode-indicator">
        <div class="round" id="roundDisplay">1/2</div>
        <div class="label" id="roundLabel">Á§∫ËåÉÊ®°Âºè</div>
    </div>

    <div class="pitch-indicator">
        <div class="value" id="pitchValue">--</div>
        <div class="label">ÂΩìÂâçÈü≥È´ò</div>
    </div>

    <div class="bottom-area">
        <div class="main-btn" id="mainBtn">
            <div class="icon">‚ñ∂Ô∏è</div>
            <div class="text">ÂºÄÂßãÊ∏∏Êàè</div>
        </div>
    </div>

    <div class="result-overlay" id="resultOverlay">
        <div class="result-panel">
            <div class="emoji" id="resultEmoji">üéØ</div>
            <div class="title" id="resultTitle">ÂÆåÊàêÔºÅ</div>
            <div class="subtitle" id="resultSubtitle">‰Ω†ÁöÑÈü≥ÂáÜËÆ≠ÁªÉÁªìÊûú</div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" style="color: #4ade80;" id="statPerfect">0</div>
                    <div class="stat-label">ÂÆåÁæé</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #fbbf24;" id="statGood">0</div>
                    <div class="stat-label">Êé•Ëøë</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #f87171;" id="statMiss">0</div>
                    <div class="stat-label">ÂÅèÁ¶ª</div>
                </div>
            </div>
            <button class="btn-restart" id="restartBtn">ÂÜçÊù•‰∏ÄÊ¨°</button>
        </div>
    </div>

    <script>
        // ==================== Èü≥‰πêËØ≠‰πâÔºöÈü≥È´òÂÆö‰πâ ====================
        // CÂ§ßË∞ÉÈü≥Èò∂Ôºå‰ªéC3Âà∞B5
        const NOTE_NAMES = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

        // ÂÆåÊï¥ÁöÑÈü≥È´òÂà∞È¢ëÁéáÁöÑÊò†Â∞ÑÔºàÈü≥‰πêËØ≠‰πâÂõ∫ÂÆöÔºâ
        const NOTE_FREQUENCIES = {
            'C3': 130.81, 'D3': 146.83, 'E3': 164.81, 'F3': 174.61, 'G3': 196.00, 'A3': 220.00, 'B3': 246.94,
            'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88,
            'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, 'A5': 880.00, 'B5': 987.77
        };

        // ==================== ‰∫îÁ∫øË∞±ÂùêÊ†áÁ≥ªÁªüÔºà‰∏•Ê†ºÂõ∫ÂÆöÔºâ ====================
        // Ê†áÂáÜÈ´òÈü≥Ë∞±Âè∑‰∫îÁ∫øË∞±ÂÆö‰πâÔºà‰ªé‰∏ãÂà∞‰∏äÔºâÔºö
        // Line 1 (Á¨¨1Á∫ø): E4
        // Space 1 (Á¨¨1Èó¥): F4
        // Line 2 (Á¨¨2Á∫ø): G4
        // Space 2 (Á¨¨2Èó¥): A4
        // Line 3 (Á¨¨3Á∫ø/‰∏≠Á∫ø): B4
        // Space 3 (Á¨¨3Èó¥): C5
        // Line 4 (Á¨¨4Á∫ø): D5
        // Space 4 (Á¨¨4Èó¥): E5
        // Line 5 (Á¨¨5Á∫ø): F5

        const STAFF_CONFIG = {
            lineSpacing: 12,  // Á∫øÈó¥Ë∑ùÔºàÂÉèÁ¥†Ôºâ
            numLines: 5,       // ‰∫îÊù°Á∫ø
            bottomPitch: 'E4', // ‰∫îÁ∫øË∞±ÊúÄ‰∏ãÁ∫øÁöÑÈü≥È´ò
        };

        // Èü≥È´òÁ¥¢ÂºïÁ≥ªÁªüÔºàÁõ∏ÂØπ‰∫éC4Ôºâ
        // C4=0, D4=1, E4=2, F4=3, G4=4, A4=5, B4=6
        // C5=7, D5=8, E5=9, F5=10, ...
        // C3=-7, D3=-6, E3=-5, ...
        function getPitchIndex(noteName) {
            const note = noteName.slice(0, -1);
            const octave = parseInt(noteName.slice(-1));
            const noteIndex = NOTE_NAMES.indexOf(note);
            return (octave - 4) * 7 + noteIndex;
        }

        // ËÆ°ÁÆó‰∫îÁ∫øË∞±YÂùêÊ†áÔºà‰∏•Ê†ºÁî±Èü≥È´òÂÜ≥ÂÆöÔºåÊó†Âä®ÁîªÔºâ
        // ËøîÂõûÔºöÁõ∏ÂØπ‰∫é‰∫îÁ∫øË∞±È°∂ÈÉ®ÁöÑÂÅèÁßªÈáèÔºà‰ª•lineSpacing‰∏∫Âçï‰ΩçÔºâ
        function pitchToStaffPosition(noteName) {
            const pitchIndex = getPitchIndex(noteName);

            // Ê†πÊçÆÊ†áÂáÜÂÆö‰πâÔºö
            // E4 (pitchIndex=2) Âú®Á¨¨1Á∫ø ‚Üí positionFromTop = 0
            // F4 (pitchIndex=3) Âú®Á¨¨1Èó¥ ‚Üí positionFromTop = 0.5
            // G4 (pitchIndex=4) Âú®Á¨¨2Á∫ø ‚Üí positionFromTop = 1
            // ...
            // B4 (pitchIndex=6) Âú®Á¨¨3Á∫ø(‰∏≠Á∫ø) ‚Üí positionFromTop = 2
            // C5 (pitchIndex=7) Âú®Á¨¨3Èó¥ ‚Üí positionFromTop = 2.5
            // F5 (pitchIndex=10) Âú®Á¨¨5Á∫ø ‚Üí positionFromTop = 4

            // ÂÖ¨ÂºèÔºöposition = (pitchIndex - 2) / 2
            //                        ^^^^^^^^^^ E4ÁöÑpitchIndex

            return (pitchIndex - 2) / 2;
        }

        // ==================== Ë∞±Èù¢Êï∞ÊçÆÁªìÊûÑ ====================
        // ÊâÄÊúâÈü≥Á¨¶Êù•Ëá™Ê≠§ÁªìÊûÑÂåñÊï∞ÊçÆ
        // startTime ÊòØÁõ∏ÂØπ‰∫éÈü≥‰πêÂºÄÂßãÁöÑÊó∂Èó¥ÔºàÁßíÔºâ

        const LEVELS = {
            1: {
                name: 'Level 1 - ÁÜüÊÇâÊóãÂæã',
                difficulty: 'easy',
                speed: 150, // ÂÉèÁ¥†/Áßí
                showNoteName: true,
                pitchRange: 'C4-G4 (Á∫Ø‰∫îÂ∫¶)',
                melodies: [
                    // 1. Â∞èÊòüÊòüÁâáÊÆµ (C-C-G-G-A-A-G)
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.8 },
                        { pitch: 'C4', startTime: 2.5, duration: 0.8 },
                        { pitch: 'G4', startTime: 3.5, duration: 0.8 },
                        { pitch: 'G4', startTime: 4.5, duration: 0.8 },
                        { pitch: 'A4', startTime: 5.5, duration: 0.8 },
                        { pitch: 'A4', startTime: 6.5, duration: 0.8 },
                        { pitch: 'G4', startTime: 7.5, duration: 1.6 }
                    ],
                    // 2. Â∞èÊòüÊòüÂâç‰∏§Èü≥
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.8 },
                        { pitch: 'C4', startTime: 2.5, duration: 0.8 },
                        { pitch: 'G4', startTime: 3.5, duration: 1.6 }
                    ],
                    // 3. ÁîüÊó•Âø´‰πêÂºÄÂ§¥
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.5 },
                        { pitch: 'C4', startTime: 2.1, duration: 0.5 },
                        { pitch: 'D4', startTime: 2.7, duration: 1.0 },
                        { pitch: 'C4', startTime: 3.9, duration: 1.0 },
                        { pitch: 'F4', startTime: 5.1, duration: 1.0 },
                        { pitch: 'E4', startTime: 6.3, duration: 2.0 }
                    ],
                    // 4. ÁîüÊó•Âø´‰πêÁª≠
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.5 },
                        { pitch: 'C4', startTime: 2.1, duration: 0.5 },
                        { pitch: 'D4', startTime: 2.7, duration: 1.0 },
                        { pitch: 'C4', startTime: 3.9, duration: 1.0 },
                        { pitch: 'G4', startTime: 5.1, duration: 1.0 },
                        { pitch: 'F4', startTime: 6.3, duration: 2.0 }
                    ],
                    // 5. ‰∏§Âè™ËÄÅËôéÁâáÊÆµ
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.6 },
                        { pitch: 'D4', startTime: 2.3, duration: 0.6 },
                        { pitch: 'E4', startTime: 3.1, duration: 0.6 },
                        { pitch: 'C4', startTime: 3.9, duration: 0.6 },
                        { pitch: 'C4', startTime: 4.7, duration: 0.6 },
                        { pitch: 'D4', startTime: 5.5, duration: 0.6 },
                        { pitch: 'E4', startTime: 6.3, duration: 0.6 },
                        { pitch: 'C4', startTime: 7.1, duration: 1.2 }
                    ],
                    // 6. ‰∏§Âè™ËÄÅËôéÂèòÂ•è
                    [
                        { pitch: 'D4', startTime: 1.5, duration: 0.6 },
                        { pitch: 'E4', startTime: 2.3, duration: 0.6 },
                        { pitch: 'F4', startTime: 3.1, duration: 0.6 },
                        { pitch: 'D4', startTime: 3.9, duration: 0.6 },
                        { pitch: 'D4', startTime: 4.7, duration: 0.6 },
                        { pitch: 'E4', startTime: 5.5, duration: 0.6 },
                        { pitch: 'F4', startTime: 6.3, duration: 0.6 },
                        { pitch: 'D4', startTime: 7.1, duration: 1.2 }
                    ],
                    // 7. Â∞èËúúËúÇÁâáÊÆµ
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.5 },
                        { pitch: 'D4', startTime: 2.2, duration: 0.5 },
                        { pitch: 'E4', startTime: 2.9, duration: 0.5 },
                        { pitch: 'F4', startTime: 3.6, duration: 0.5 },
                        { pitch: 'G4', startTime: 4.3, duration: 0.5 },
                        { pitch: 'G4', startTime: 5.0, duration: 0.5 },
                        { pitch: 'G4', startTime: 5.7, duration: 1.2 }
                    ],
                    // 8. Â∞èËúúËúÇÁÆÄÂåñ
                    [
                        { pitch: 'E4', startTime: 1.5, duration: 0.5 },
                        { pitch: 'F4', startTime: 2.2, duration: 0.5 },
                        { pitch: 'G4', startTime: 2.9, duration: 0.5 },
                        { pitch: 'E4', startTime: 3.6, duration: 1.5 }
                    ]
                ]
            },
            2: {
                name: 'Level 2 - ÊúâË∂£Ê®°‰ªø',
                difficulty: 'medium',
                speed: 160,
                showNoteName: false,
                pitchRange: 'G3-C5 (ÂÖ´Â∫¶)',
                melodies: [
                    // 1. È∏üÂè´Â£∞ (È´ò-‰Ωé-È´ò Âø´ÈÄüÊåØËç°)
                    [
                        { pitch: 'C5', startTime: 1.5, duration: 0.15 },
                        { pitch: 'G4', startTime: 1.75, duration: 0.15 },
                        { pitch: 'C5', startTime: 1.9, duration: 0.15 },
                        { pitch: 'G4', startTime: 2.15, duration: 0.15 },
                        { pitch: 'C5', startTime: 2.3, duration: 0.3 }
                    ],
                    // 2. Áå´Âè´Â£∞ (È´ò-‰Ωé-È´ò)
                    [
                        { pitch: 'G4', startTime: 1.5, duration: 0.3 },
                        { pitch: 'E4', startTime: 1.95, duration: 0.8 },
                        { pitch: 'G4', startTime: 2.9, duration: 0.5 }
                    ],
                    // 3. Áå´Âè´Â£∞ÂèòÂ•è
                    [
                        { pitch: 'A4', startTime: 1.5, duration: 0.3 },
                        { pitch: 'F4', startTime: 1.95, duration: 0.8 },
                        { pitch: 'A4', startTime: 2.9, duration: 0.5 }
                    ],
                    // 4. ÁâõÂè´Â£∞ (Èïø‰ΩéÈü≥)
                    [
                        { pitch: 'G3', startTime: 1.5, duration: 1.2 },
                        { pitch: 'G3', startTime: 2.9, duration: 0.4 },
                        { pitch: 'A3', startTime: 3.5, duration: 0.4 }
                    ],
                    // 5. ÁæäÂè´Â£∞ (Áü≠‰øÉÈ´òÈü≥)
                    [
                        { pitch: 'B4', startTime: 1.5, duration: 0.2 },
                        { pitch: 'B4', startTime: 1.8, duration: 0.2 },
                        { pitch: 'B4', startTime: 2.1, duration: 0.2 },
                        { pitch: 'A4', startTime: 2.5, duration: 0.3 }
                    ],
                    // 6. ÁãóÂè´Â£∞ (‰Ωé-È´ò)
                    [
                        { pitch: 'G3', startTime: 1.5, duration: 0.3 },
                        { pitch: 'G3', startTime: 1.95, duration: 0.3 },
                        { pitch: 'C4', startTime: 2.4, duration: 0.6 },
                        { pitch: 'C4', startTime: 3.15, duration: 0.4 }
                    ],
                    // 7. ÈìÉÈìõÂ£∞ (Ê∏ÖËÑÜ)
                    [
                        { pitch: 'A4', startTime: 1.5, duration: 0.4 },
                        { pitch: 'B4', startTime: 2.1, duration: 0.4 },
                        { pitch: 'C5', startTime: 2.7, duration: 0.8 }
                    ],
                    // 8. ÂñµÂè´(2) (È´ò-‰Ωé-È´ò-‰Ωé)
                    [
                        { pitch: 'G4', startTime: 1.5, duration: 0.25 },
                        { pitch: 'E4', startTime: 1.9, duration: 0.4 },
                        { pitch: 'G4', startTime: 2.45, duration: 0.25 },
                        { pitch: 'D4', startTime: 2.85, duration: 0.6 }
                    ]
                ]
            },
            3: {
                name: 'Level 3 - Èü≥ÂáÜËÆ≠ÁªÉ',
                difficulty: 'medium-hard',
                speed: 180,
                showNoteName: false,
                pitchRange: 'C4-A5 (ÂçÅÂ∫¶)',
                melodies: [
                    // 1. CÂ§ßË∞ÉÈü≥Èò∂‰∏äË°å
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.5 },
                        { pitch: 'D4', startTime: 2.1, duration: 0.5 },
                        { pitch: 'E4', startTime: 2.7, duration: 0.5 },
                        { pitch: 'F4', startTime: 3.3, duration: 0.5 },
                        { pitch: 'G4', startTime: 3.9, duration: 0.5 },
                        { pitch: 'A4', startTime: 4.5, duration: 0.5 },
                        { pitch: 'B4', startTime: 5.1, duration: 0.5 },
                        { pitch: 'C5', startTime: 5.7, duration: 1.0 }
                    ],
                    // 2. CÂ§ßË∞ÉÈü≥Èò∂‰∏ãË°å
                    [
                        { pitch: 'C5', startTime: 1.5, duration: 0.5 },
                        { pitch: 'B4', startTime: 2.1, duration: 0.5 },
                        { pitch: 'A4', startTime: 2.7, duration: 0.5 },
                        { pitch: 'G4', startTime: 3.3, duration: 0.5 },
                        { pitch: 'F4', startTime: 3.9, duration: 0.5 },
                        { pitch: 'E4', startTime: 4.5, duration: 0.5 },
                        { pitch: 'D4', startTime: 5.1, duration: 0.5 },
                        { pitch: 'C4', startTime: 5.7, duration: 1.0 }
                    ],
                    // 3. ‰∏âÂ∫¶Èü≥Á®ãÁªÉ‰π†
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.6 },
                        { pitch: 'E4', startTime: 2.3, duration: 0.6 },
                        { pitch: 'D4', startTime: 3.1, duration: 0.6 },
                        { pitch: 'F4', startTime: 3.9, duration: 0.6 },
                        { pitch: 'E4', startTime: 4.7, duration: 0.6 },
                        { pitch: 'G4', startTime: 5.5, duration: 0.6 },
                        { pitch: 'F4', startTime: 6.3, duration: 1.2 }
                    ],
                    // 4. ‰∫îÂ∫¶Ë∑≥Ë∑É
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.8 },
                        { pitch: 'G4', startTime: 2.5, duration: 0.8 },
                        { pitch: 'D4', startTime: 3.5, duration: 0.8 },
                        { pitch: 'A4', startTime: 4.5, duration: 0.8 },
                        { pitch: 'E4', startTime: 5.5, duration: 1.2 }
                    ],
                    // 5. Á∫ßËøõ+Ë∑≥Ë∑ÉÁªÑÂêà
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.5 },
                        { pitch: 'D4', startTime: 2.1, duration: 0.5 },
                        { pitch: 'E4', startTime: 2.7, duration: 0.5 },
                        { pitch: 'G4', startTime: 3.3, duration: 0.8 },
                        { pitch: 'F4', startTime: 4.3, duration: 0.5 },
                        { pitch: 'E4', startTime: 4.9, duration: 0.5 },
                        { pitch: 'D4', startTime: 5.5, duration: 0.5 },
                        { pitch: 'C4', startTime: 6.1, duration: 1.0 }
                    ],
                    // 6. ÂÖ´Â∫¶Èü≥Á®ã
                    [
                        { pitch: 'C4', startTime: 1.5, duration: 0.8 },
                        { pitch: 'C5', startTime: 2.5, duration: 0.8 },
                        { pitch: 'D4', startTime: 3.5, duration: 0.8 },
                        { pitch: 'D5', startTime: 4.5, duration: 0.8 },
                        { pitch: 'C4', startTime: 5.5, duration: 1.2 }
                    ],
                    // 7. ÂõûÈü≥Èü≥Âûã
                    [
                        { pitch: 'E4', startTime: 1.5, duration: 0.4 },
                        { pitch: 'F4', startTime: 2.0, duration: 0.4 },
                        { pitch: 'E4', startTime: 2.5, duration: 0.4 },
                        { pitch: 'D4', startTime: 3.0, duration: 0.4 },
                        { pitch: 'C4', startTime: 3.5, duration: 1.2 }
                    ],
                    // 8. Ê≥¢Âä®Èü≥Âûã
                    [
                        { pitch: 'E4', startTime: 1.5, duration: 0.5 },
                        { pitch: 'G4', startTime: 2.1, duration: 0.5 },
                        { pitch: 'E4', startTime: 2.7, duration: 0.5 },
                        { pitch: 'G4', startTime: 3.3, duration: 0.5 },
                        { pitch: 'A4', startTime: 3.9, duration: 1.0 }
                    ]
                ]
            }
        };

        // ==================== ÂÖ®Â±ÄÁä∂ÊÄÅ ====================
        let audioContext = null;
        let analyser = null;
        let mediaStream = null;
        let selectedSoundType = 'triangle';
        let currentLevel = 1;
        let gameRunning = false;
        let isSinging = false;
        let audioInitialized = false;

        let currentPhase = 'idle'; // 'idle', 'demo', 'perform'
        let currentMelody = []; // Êù•Ëá™Ë∞±Èù¢Êï∞ÊçÆ
        let gameNotes = [];
        let hitPoints = [];
        let waveRings = [];
        let arrows = [];
        let currentDemoNote = null;

        // ÂèåÊó∂Èó¥Èõ∂ÁÇπÊ®°Âûã
        let demoStartTime = 0;   // Á§∫ËåÉÈò∂ÊÆµÊó∂Èó¥Èõ∂ÁÇπ
        let performStartTime = 0; // ÊºîÂî±Èò∂ÊÆµÊó∂Èó¥Èõ∂ÁÇπ

        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let stats = { perfect: 0, good: 0, miss: 0 };

        // Á§∫ËåÉÈü≥Ë∞ÉÂ∫¶Âô®
        let demoToneTimers = [];

        let pitchHistory = [];
        const PITCH_SMOOTHING = 3;
        const CENTS_THRESHOLD = 30;
        const GOOD_CENTS_THRESHOLD = 50;
        const TIMING_WINDOW = 0.15; // Âà§ÂÆöÊó∂Èó¥Á™óÂè£ÔºàÁßíÔºâ

        // ==================== Canvas ËÆæÁΩÆ ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let staff = {
            y: 0,
            lineSpacing: STAFF_CONFIG.lineSpacing,
            numLines: STAFF_CONFIG.numLines,
            judgeX: 0
        };

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            ctx.scale(dpr, dpr);

            staff.y = window.innerHeight * 0.38;
            staff.lineSpacing = Math.min(STAFF_CONFIG.lineSpacing, window.innerHeight * 0.02);
            staff.judgeX = window.innerWidth * 0.35;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ==================== Èü≥È¢ëÁ≥ªÁªü ====================
        async function initAudio() {
            if (audioInitialized) return true;

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                audioInitialized = true;
                console.log('[Èü≥È¢ë] ÂàùÂßãÂåñÂÆåÊàê');
                return true;
            } catch (error) {
                console.error('[Èü≥È¢ë] ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                return false;
            }
        }

        // Êí≠ÊîæÁ§∫ËåÉÈü≥Ôºà‰ΩøÁî®Ë∞±Èù¢Êï∞ÊçÆ‰∏≠ÁöÑpitchÔºâ
        function playDemoTone(pitch, duration = 500) {
            return new Promise((resolve) => {
                if (!audioContext || !audioInitialized) {
                    resolve();
                    return;
                }

                const freq = NOTE_FREQUENCIES[pitch];
                if (!freq) {
                    resolve();
                    return;
                }

                console.log(`[Á§∫ËåÉÈü≥] ${pitch} (${freq.toFixed(1)}Hz)`);

                try {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();

                    osc.type = selectedSoundType === 'triangle' ? 'triangle' : 'sine';
                    osc.frequency.value = freq;

                    osc.connect(gain);
                    gain.connect(audioContext.destination);

                    const now = audioContext.currentTime;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.35, now + 0.05);
                    gain.gain.linearRampToValueAtTime(0.3, now + duration / 1000 - 0.1);
                    gain.gain.linearRampToValueAtTime(0, now + duration / 1000);

                    osc.start(now);
                    osc.stop(now + duration / 1000);

                    createWaveRings(duration / 1000);

                    osc.onended = resolve;
                } catch (error) {
                    console.error('[Á§∫ËåÉÈü≥] Êí≠ÊîæÂ§±Ë¥•:', error);
                    resolve();
                }
            });
        }

        function createWaveRings(duration) {
            const startTime = Date.now();
            const interval = setInterval(() => {
                if (Date.now() - startTime > duration * 1000) {
                    clearInterval(interval);
                    return;
                }
                waveRings.push({
                    radius: staff.lineSpacing * 2.5,
                    maxRadius: staff.lineSpacing * 8,
                    opacity: 0.6,
                    phase: 0
                });
            }, 150);
        }

        // ==================== Èü≥È´òÊ£ÄÊµã ====================
        function autocorrelate(buffer, sampleRate) {
            const SIZE = buffer.length;
            const MAX_SAMPLES = Math.floor(SIZE / 2);
            let bestOffset = -1;
            let bestCorrelation = 0;
            let rms = 0;

            for (let i = 0; i < SIZE; i++) rms += buffer[i] * buffer[i];
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;

            let lastCorrelation = 1;
            let foundGoodCorrelation = false;

            for (let offset = 0; offset < MAX_SAMPLES; offset++) {
                let correlation = 0;
                for (let i = 0; i < MAX_SAMPLES; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - (correlation / MAX_SAMPLES);

                if (correlation > 0.9 && correlation > lastCorrelation) {
                    foundGoodCorrelation = true;
                    if (correlation > bestCorrelation) {
                        bestCorrelation = correlation;
                        bestOffset = offset;
                    }
                } else if (foundGoodCorrelation) {
                    return sampleRate / bestOffset;
                }
                lastCorrelation = correlation;
            }

            if (bestCorrelation > 0.01) return sampleRate / bestOffset;
            return -1;
        }

        function detectPitch(buffer) {
            const sampleRate = audioContext.sampleRate;
            const frequency = autocorrelate(buffer, sampleRate);
            if (frequency === -1 || frequency < 80 || frequency > 1200) return null;
            return frequency;
        }

        function calculateCentsDiff(userFreq, targetFreq) {
            return 1200 * Math.log2(userFreq / targetFreq);
        }

        function smoothPitch(pitch) {
            pitchHistory.push(pitch);
            if (pitchHistory.length > PITCH_SMOOTHING) {
                pitchHistory.shift();
            }
            return pitchHistory.reduce((a, b) => a + b, 0) / pitchHistory.length;
        }

        function frequencyToNoteName(freq) {
            let minDiff = Infinity;
            let closestNote = null;

            for (const [note, noteFreq] of Object.entries(NOTE_FREQUENCIES)) {
                const diff = Math.abs(freq - noteFreq);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestNote = note;
                }
            }
            return closestNote;
        }

        // ==================== ‰∫îÁ∫øË∞±Ê∏≤ÊüìÁ≥ªÁªü ====================

        // Ëé∑ÂèñÈü≥Á¨¶Âú®‰∫îÁ∫øË∞±‰∏äÁöÑYÂùêÊ†áÔºà‰∏•Ê†ºÁî±pitchÂÜ≥ÂÆöÔºâ
        function getNoteY(pitch) {
            const positionFromTop = pitchToStaffPosition(pitch);
            return staff.y + positionFromTop * staff.lineSpacing;
        }

        // ÁªòÂà∂‰∫îÁ∫øË∞±ÔºàÂÆåÂÖ®ÈùôÊ≠¢Ôºâ
        function drawStaff() {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 1.5;

            // ÁªòÂà∂‰∫îÊù°Á∫ø
            for (let i = 0; i < staff.numLines; i++) {
                const y = staff.y + i * staff.lineSpacing;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(window.innerWidth, y);
                ctx.stroke();
            }

            // È´òÈü≥Ë∞±Âè∑
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = `${staff.lineSpacing * 5}px serif`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText('ùÑû', 20, staff.y + staff.lineSpacing * 1.5);

            // Âà§ÂÆöÁ∫øÔºàÂõ∫ÂÆöÁöÑÁ´ñÁõ¥Á∫øÔºâ
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.8)';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(staff.judgeX, staff.y - staff.lineSpacing * 3);
            ctx.lineTo(staff.judgeX, staff.y + staff.lineSpacing * 5);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = 'rgba(255, 215, 0, 0.9)';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Âà§ÂÆöÁ∫ø', staff.judgeX, staff.y - staff.lineSpacing * 3.5);
        }

        // ÁªòÂà∂ÂΩìÂâçÁ§∫ËåÉÈü≥Á¨¶ÔºàÂú®Âà§ÂÆöÁ∫ø‰ΩçÁΩÆÔºåYÂùêÊ†á‰∏•Ê†ºÁî±pitchÂÜ≥ÂÆöÔºâ
        function drawCurrentDemoNote() {
            if (!currentDemoNote) return;

            const pitch = currentDemoNote.pitch;
            const y = getNoteY(pitch); // ‰∏•Ê†ºÁî±pitchËÆ°ÁÆóYÂùêÊ†á
            const size = staff.lineSpacing * 1.2;

            // ÂèëÂÖâÊïàÊûú
            const gradient = ctx.createRadialGradient(staff.judgeX, y, 0, staff.judgeX, y, size * 2);
            gradient.addColorStop(0, 'rgba(240, 147, 251, 0.8)');
            gradient.addColorStop(0.5, 'rgba(245, 87, 108, 0.4)');
            gradient.addColorStop(1, 'rgba(245, 87, 108, 0)');

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(staff.judgeX, y, size * 2, 0, Math.PI * 2);
            ctx.fill();

            // Èü≥Á¨¶Â§¥
            ctx.fillStyle = '#f093fb';
            ctx.beginPath();
            ctx.ellipse(staff.judgeX, y, size * 0.9, size * 0.6, 0, 0, Math.PI * 2);
            ctx.fill();

            // Èü≥Á¨¶ÊùÜ
            ctx.strokeStyle = '#f093fb';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(staff.judgeX + size * 0.8, y);
            ctx.lineTo(staff.judgeX + size * 0.8, y - staff.lineSpacing * 3.5);
            ctx.stroke();

            // Èü≥Á¨¶ÂêçÁß∞
            if (LEVELS[currentLevel].showNoteName) {
                ctx.fillStyle = '#f093fb';
                ctx.font = 'bold 18px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(pitch, staff.judgeX, y - staff.lineSpacing * 4.5);
            }
        }

        // ==================== Èü≥Á¨¶Á±ªÔºàË∞±Èù¢ÂØπË±°Ôºâ ====================
        class GameNote {
            constructor(noteData, speed) {
                // Ë∞±Èù¢Êï∞ÊçÆÔºà‰∏çÂèòÔºâ
                this.pitch = noteData.pitch;
                this.start = noteData.startTime; // Âú®Èü≥‰πê‰∏≠ÁöÑÁªùÂØπÊó∂Èó¥ÔºàÁßíÔºâ
                this.duration = noteData.duration;
                this.frequency = NOTE_FREQUENCIES[this.pitch];
                this.noteY = getNoteY(this.pitch);

                // Á©∫Èó¥Á≥ªÁªü
                this.judgeX = staff.judgeX;
                this.speed = speed;

                // Áä∂ÊÄÅ
                this.hit = false;
                this.missed = false;
                this.x = 0;
            }

            update(now, phase, phaseStartTime) {
                // ËÆ°ÁÆóÂΩìÂâçÈò∂ÊÆµÁöÑÊó∂Èó¥
                const phaseTime = now - phaseStartTime;

                // ‰ΩçÁΩÆËÆ°ÁÆóÔºöx = judgeLineX + (note.start - phaseTime) * speed
                const delta = this.start - phaseTime;
                this.x = this.judgeX + delta * this.speed;

                // Phase 1: Á§∫ËåÉÈò∂ÊÆµ - ÊòæÁ§∫Á§∫ËåÉÈü≥Á¨¶
                // Phase 2: ÊºîÂî±Èò∂ÊÆµ - Ê£ÄÊµãÁî®Êà∑ÂèëÂ£∞
                if (phase === 'perform' && !this.hit && !this.missed) {
                    // Âà§ÂÆöÊó∂Èó¥Á™óÂè£
                    if (Math.abs(delta) < TIMING_WINDOW) {
                        // Âú®Âà§ÂÆöÁ™óÂè£ÂÜÖÔºåÁ≠âÂæÖÁî®Êà∑ÂèëÂ£∞ÔºàÂú® detectPitchLoop ‰∏≠Â§ÑÁêÜÔºâ
                    } else if (delta < -0.2) {
                        // ÈîôËøáÂà§ÂÆöÁ™óÂè£
                        this.missed = true;
                        stats.miss++;
                        combo = 0;
                        updateDisplay();
                    }
                }

                return this.x > -50;
            }

            draw(phase) {
                const y = this.noteY;
                const size = staff.lineSpacing * 0.8;

                // Ê†πÊçÆÈò∂ÊÆµËÆæÁΩÆÈ¢úËâ≤
                let color;
                if (phase === 'demo') {
                    color = this.hit ? '#4ade80' : '#f093fb'; // Á§∫ËåÉÈò∂ÊÆµÔºöÁ≤âËâ≤
                } else {
                    if (this.hit) {
                        color = '#4ade80';
                    } else if (this.missed) {
                        color = '#f87171';
                    } else {
                        color = '#60a5fa';
                    }
                }

                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.ellipse(this.x, y, size * 0.8, size * 0.6, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(this.x + size * 0.7, y);
                ctx.lineTo(this.x + size * 0.7, y - staff.lineSpacing * 3.5);
                ctx.stroke();

                if (LEVELS[currentLevel].showNoteName) {
                    ctx.fillStyle = color;
                    ctx.font = 'bold 14px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(this.pitch, this.x, y - staff.lineSpacing * 4);
                }
            }
        }

        // ==================== ÂëΩ‰∏≠ÁÇπÁ±ª ====================
        class HitPoint {
            constructor(x, y, isPerfect) {
                this.x = x;
                this.y = y;
                this.isPerfect = isPerfect;
                this.scale = 0;
                this.opacity = 1;
            }

            update() {
                if (this.scale < 1) this.scale += 0.15;
                this.opacity -= 0.02;
                return this.opacity > 0;
            }

            draw() {
                const size = 12 * this.scale;
                const color = this.isPerfect ? '#4ade80' : '#fbbf24';

                ctx.strokeStyle = color;
                ctx.globalAlpha = this.opacity;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                ctx.stroke();

                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, size * 0.5, 0, Math.PI * 2);
                ctx.fill();

                ctx.globalAlpha = 1;
            }
        }

        // ==================== Èü≥Êµ™ÁéØ ====================
        function drawWaveRings() {
            for (let i = waveRings.length - 1; i >= 0; i--) {
                const ring = waveRings[i];
                ring.radius += 2;
                ring.opacity -= 0.012;

                if (ring.opacity <= 0 || ring.radius > ring.maxRadius) {
                    waveRings.splice(i, 1);
                    continue;
                }

                ctx.strokeStyle = `rgba(139, 92, 246, ${ring.opacity})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(staff.judgeX, staff.y + staff.lineSpacing * 2, ring.radius, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        // ==================== ÂèëÂ£∞ÁÆ≠Â§¥ ====================
        let lastArrowTime = 0;
        const ARROW_INTERVAL = 100;

        class SingArrow {
            constructor(targetX, targetY, cents) {
                this.startX = window.innerWidth / 2;
                this.startY = window.innerHeight - 150;
                this.targetX = targetX;
                this.targetY = targetY;
                this.cents = cents;
                this.progress = 0;
                this.speed = 0.08;
            }

            update() {
                this.progress += this.speed;
                return this.progress < 1;
            }

            draw() {
                const x = this.startX + (this.targetX - this.startX) * this.progress;
                const y = this.startY + (this.targetY - this.startY) * this.progress;

                const absCents = Math.abs(this.cents);
                let color;
                if (absCents <= CENTS_THRESHOLD) color = '#4ade80';
                else if (absCents <= GOOD_CENTS_THRESHOLD) color = '#fbbf24';
                else color = '#f87171';

                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.lineWidth = 3;

                ctx.beginPath();
                ctx.moveTo(this.startX, this.startY);
                ctx.lineTo(x, y);
                ctx.stroke();

                const angle = Math.atan2(this.targetY - this.startY, this.targetX - this.startX);
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(-15, -8);
                ctx.lineTo(-15, 8);
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }

        // ==================== Ê∏∏ÊàèÊéßÂà∂ ====================
        async function startGame() {
            console.log('[Ê∏∏Êàè] ÂºÄÂßãÂàùÂßãÂåñ...');
            const success = await initAudio();
            if (!success) {
                alert('Èü≥È¢ëÂàùÂßãÂåñÂ§±Ë¥•');
                return;
            }

            const levelConfig = LEVELS[currentLevel];
            const melodyIndex = Math.floor(Math.random() * levelConfig.melodies.length);
            currentMelody = levelConfig.melodies[melodyIndex];
            console.log('[Ê∏∏Êàè] ÈÄâÊã©ÊóãÂæã:', currentMelody);

            // ÈáçÁΩÆÁä∂ÊÄÅ
            gameNotes = [];
            hitPoints = [];
            waveRings = [];
            arrows = [];
            currentDemoNote = null;
            demoToneTimers = [];
            score = 0;
            combo = 0;
            maxCombo = 0;
            stats = { perfect: 0, good: 0, miss: 0 };

            gameRunning = true;
            currentPhase = 'demo';

            updatePhaseDisplay();
            updateDisplay();

            console.log('[Ê∏∏Êàè] ÂºÄÂßãÁ§∫ËåÉÈò∂ÊÆµ...');
            // ÂºÄÂßãÁ§∫ËåÉÈò∂ÊÆµ
            startDemoPhase();
        }

        function startDemoPhase() {
            console.log('[Á§∫ËåÉÈò∂ÊÆµ] ÂºÄÂßã, audioContext.currentTime =', audioContext.currentTime);
            currentPhase = 'demo';
            demoStartTime = audioContext.currentTime;

            // ÂàõÂª∫Èü≥Á¨¶
            const levelConfig = LEVELS[currentLevel];
            currentMelody.forEach((noteData) => {
                const note = new GameNote(noteData, levelConfig.speed);
                gameNotes.push(note);
            });

            // ‰∏ÄÊ¨°ÊÄßË∞ÉÂ∫¶ÊâÄÊúâÁ§∫ËåÉÈü≥
            currentMelody.forEach((noteData) => {
                // ‰ΩøÁî® noteData.startTime Áõ¥Êé•‰Ωú‰∏∫Âª∂ËøüÔºàËΩ¨Êç¢‰∏∫ÊØ´ÁßíÔºâ
                const delay = noteData.startTime * 1000;
                console.log(`[Á§∫ËåÉÈò∂ÊÆµ] Ë∞ÉÂ∫¶Èü≥Á¨¶ ${noteData.pitch}, Âª∂Ëøü ${delay}ms`);

                const timerId = setTimeout(() => {
                    if (currentPhase === 'demo' && gameRunning) {
                        console.log(`[Á§∫ËåÉÈò∂ÊÆµ] Êí≠ÊîæÈü≥Á¨¶ ${noteData.pitch}`);
                        currentDemoNote = { pitch: noteData.pitch };
                        const demoDuration = Math.min(600, noteData.duration * 1000 * 0.8);
                        playDemoTone(noteData.pitch, demoDuration);

                        setTimeout(() => {
                            if (currentDemoNote && currentDemoNote.pitch === noteData.pitch) {
                                currentDemoNote = null;
                            }
                        }, demoDuration);
                    }
                }, delay);

                demoToneTimers.push(timerId);
            });

            // ËÆ°ÁÆóÁ§∫ËåÉÈò∂ÊÆµÁªìÊùüÊó∂Èó¥Ôºà‰ΩøÁî®ÊúÄÂêé‰∏Ä‰∏™Èü≥Á¨¶ÁöÑÊó∂Èó¥Ôºâ
            const lastNote = currentMelody[currentMelody.length - 1];
            const demoPhaseDuration = lastNote.startTime + lastNote.duration + 0.5; // Áßí
            console.log(`[Á§∫ËåÉÈò∂ÊÆµ] Èò∂ÊÆµÂ∞ÜÂú® ${demoPhaseDuration * 1000}ms ÂêéÁªìÊùü`);

            const endTimerId = setTimeout(() => {
                if (gameRunning) {
                    console.log('[Á§∫ËåÉÈò∂ÊÆµ] ÁªìÊùüÔºåÂºÄÂßãÊºîÂî±Èò∂ÊÆµ');
                    startPerformPhase();
                }
            }, demoPhaseDuration * 1000);

            demoToneTimers.push(endTimerId);

            updatePhaseDisplay();
        }

        function startPerformPhase() {
            console.log('[ÊºîÂî±Èò∂ÊÆµ] ÂºÄÂßã');
            currentPhase = 'perform';
            performStartTime = audioContext.currentTime;

            // Ê∏ÖÁêÜÁ§∫ËåÉÈü≥ÂÆöÊó∂Âô®
            demoToneTimers.forEach(id => clearTimeout(id));
            demoToneTimers = [];

            // ÈáçÊñ∞ÂàõÂª∫Èü≥Á¨¶Ôºà‰∏éÁ§∫ËåÉÈò∂ÊÆµÁõ∏ÂêåÔºâ
            const levelConfig = LEVELS[currentLevel];
            gameNotes = [];
            currentMelody.forEach((noteData) => {
                const note = new GameNote(noteData, levelConfig.speed);
                gameNotes.push(note);
            });

            // ËÆ°ÁÆóÊºîÂî±Èò∂ÊÆµÁªìÊùüÊó∂Èó¥Ôºà‰ΩøÁî®ÊúÄÂêé‰∏Ä‰∏™Èü≥Á¨¶ÁöÑÊó∂Èó¥Ôºâ
            const lastNote = currentMelody[currentMelody.length - 1];
            const performPhaseDuration = lastNote.startTime + lastNote.duration + 1.5; // Áßí
            console.log(`[ÊºîÂî±Èò∂ÊÆµ] Èò∂ÊÆµÂ∞ÜÂú® ${performPhaseDuration * 1000}ms ÂêéÁªìÊùü`);

            const endTimerId = setTimeout(() => {
                if (gameRunning) {
                    console.log('[ÊºîÂî±Èò∂ÊÆµ] ÁªìÊùüÔºåË∞ÉÁî® endGame()');
                    endGame();
                }
            }, performPhaseDuration * 1000);

            demoToneTimers.push(endTimerId);

            updatePhaseDisplay();

            // Ëá™Âä®ÂºÄÂêØÈ∫¶ÂÖãÈ£é
            startSinging();
        }

        function updatePhaseDisplay() {
            const modeDisplay = document.getElementById('modeDisplay');
            const roundDisplay = document.getElementById('roundDisplay');
            const roundLabel = document.getElementById('roundLabel');
            const mainBtn = document.getElementById('mainBtn');

            if (currentPhase === 'demo') {
                modeDisplay.textContent = 'Á§∫ËåÉÈò∂ÊÆµ - ‰ªîÁªÜÂê¨';
                roundDisplay.textContent = '1/2';
                roundLabel.textContent = 'Á§∫ËåÉ‰∏≠';
                mainBtn.classList.add('demo-mode');
                mainBtn.classList.remove('sing-mode');
                mainBtn.querySelector('.icon').textContent = 'üéµ';
                mainBtn.querySelector('.text').textContent = 'Âê¨Á§∫ËåÉ';
            } else if (currentPhase === 'perform') {
                modeDisplay.textContent = 'ÊºîÂî±Èò∂ÊÆµ - ËØ∑Ë∑üÂî±';
                roundDisplay.textContent = '2/2';
                roundLabel.textContent = 'Ë∑üÂî±‰∏≠';
                mainBtn.classList.remove('demo-mode');
                mainBtn.classList.add('sing-mode');
                mainBtn.querySelector('.icon').textContent = 'üé§';
                mainBtn.querySelector('.text').textContent = 'ÊºîÂî±‰∏≠...';
            } else {
                modeDisplay.textContent = 'ÂáÜÂ§áÂºÄÂßã';
                roundDisplay.textContent = '-';
                roundLabel.textContent = '';
                mainBtn.classList.remove('demo-mode', 'sing-mode');
                mainBtn.querySelector('.icon').textContent = '‚ñ∂Ô∏è';
                mainBtn.querySelector('.text').textContent = 'ÂºÄÂßãÊ∏∏Êàè';
            }
        }

        function endGame() {
            console.log('[Ê∏∏ÊàèÁªìÊùü] endGame() Ë¢´Ë∞ÉÁî®');
            gameRunning = false;
            stopSinging();
            currentPhase = 'idle';

            // Ê∏ÖÁêÜÊâÄÊúâÂÆöÊó∂Âô®
            demoToneTimers.forEach(id => clearTimeout(id));
            demoToneTimers = [];

            const overlay = document.getElementById('resultOverlay');
            const emoji = document.getElementById('resultEmoji');
            const title = document.getElementById('resultTitle');

            const totalNotes = stats.perfect + stats.good + stats.miss;
            const accuracy = totalNotes > 0 ? Math.round((stats.perfect + stats.good) / totalNotes * 100) : 0;

            if (accuracy >= 90) {
                emoji.textContent = 'üèÜ';
                title.textContent = 'ÂÆåÁæéÔºÅ';
            } else if (accuracy >= 70) {
                emoji.textContent = 'üéØ';
                title.textContent = 'ÂæàÊ£íÔºÅ';
            } else {
                emoji.textContent = 'üí™';
                title.textContent = 'ÁªßÁª≠Âä†Ê≤πÔºÅ';
            }

            document.getElementById('resultSubtitle').textContent = `ÂæóÂàÜ: ${score} | ÊúÄÈ´òËøûÂáª: ${maxCombo}`;
            document.getElementById('statPerfect').textContent = stats.perfect;
            document.getElementById('statGood').textContent = stats.good;
            document.getElementById('statMiss').textContent = stats.miss;

            overlay.classList.add('show');
            resetMainButton();
        }

        // ÂÅúÊ≠¢Ê∏∏ÊàèÔºàÊâãÂä®ÂÅúÊ≠¢Ôºâ
        function stopGame() {
            gameRunning = false;
            currentPhase = 'idle';
            stopSinging();

            // Ê∏ÖÁêÜÊâÄÊúâÂÆöÊó∂Âô®
            demoToneTimers.forEach(id => clearTimeout(id));
            demoToneTimers = [];

            gameNotes = [];
            hitPoints = [];
            waveRings = [];
            arrows = [];
            currentDemoNote = null;
            currentMelody = [];
            score = 0;
            combo = 0;
            maxCombo = 0;
            stats = { perfect: 0, good: 0, miss: 0 };

            updatePhaseDisplay();
            updateDisplay();
        }

        function resetMainButton() {
            const mainBtn = document.getElementById('mainBtn');
            mainBtn.classList.remove('demo-mode', 'sing-mode', 'singing');
            mainBtn.querySelector('.icon').textContent = '‚ñ∂Ô∏è';
            mainBtn.querySelector('.text').textContent = 'ÂºÄÂßãÊ∏∏Êàè';
        }

        function updateDisplay() {
            document.getElementById('scoreDisplay').textContent = `ÂæóÂàÜ: ${score}`;
            document.getElementById('comboDisplay').textContent = combo > 1 ? `ËøûÂáª x${combo}` : '';
        }

        // ==================== ÂèëÂ£∞Ê£ÄÊµã ====================
        async function startSinging() {
            if (isSinging) return;

            try {
                if (!audioContext || !audioInitialized) {
                    await initAudio();
                }

                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);

                isSinging = true;
                pitchHistory = [];

                document.getElementById('mainBtn').classList.add('singing');

                detectPitchLoop();

            } catch (error) {
                console.error('[È∫¶ÂÖãÈ£é] ÈîôËØØ:', error);
                alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
            }
        }

        function stopSinging() {
            isSinging = false;
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            document.getElementById('mainBtn').classList.remove('singing');
            document.getElementById('pitchValue').textContent = '--';
        }

        function detectPitchLoop() {
            if (!isSinging || !analyser || currentPhase !== 'perform') return;

            const bufferLength = analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(buffer);

            const pitch = detectPitch(buffer);

            if (pitch) {
                const smoothedPitch = smoothPitch(pitch);
                const noteName = frequencyToNoteName(smoothedPitch);

                document.getElementById('pitchValue').textContent = noteName || '--';

                // ËÆ°ÁÆóÊºîÂî±Èò∂ÊÆµÊó∂Èó¥
                const performTime = audioContext.currentTime - performStartTime;

                // Ê£ÄÊü•ÊòØÂê¶ÂëΩ‰∏≠Âà§ÂÆöÁ∫ø‰∏äÁöÑÈü≥Á¨¶
                const activeNote = gameNotes.find(n => {
                    const delta = n.start - performTime;
                    return !n.hit && !n.missed && Math.abs(delta) < TIMING_WINDOW;
                });

                if (activeNote) {
                    const centsDiff = calculateCentsDiff(smoothedPitch, activeNote.frequency);
                    const absCents = Math.abs(centsDiff);

                    const now = Date.now();
                    if (now - lastArrowTime > ARROW_INTERVAL) {
                        arrows.push(new SingArrow(
                            staff.judgeX,
                            activeNote.noteY,
                            centsDiff
                        ));
                        lastArrowTime = now;

                        waveRings.push({
                            radius: staff.lineSpacing * 2,
                            maxRadius: staff.lineSpacing * 6,
                            opacity: 0.4,
                            phase: 0
                        });
                    }

                    if (absCents <= CENTS_THRESHOLD) {
                        activeNote.hit = true;
                        stats.perfect++;
                        score += 100 + combo * 10;
                        combo++;
                        maxCombo = Math.max(maxCombo, combo);
                        hitPoints.push(new HitPoint(staff.judgeX, activeNote.noteY, true));
                        updateDisplay();
                    } else if (absCents <= GOOD_CENTS_THRESHOLD) {
                        activeNote.hit = true;
                        stats.good++;
                        score += 50 + combo * 5;
                        combo++;
                        maxCombo = Math.max(maxCombo, combo);
                        hitPoints.push(new HitPoint(staff.judgeX, activeNote.noteY, false));
                        updateDisplay();
                    }
                }
            }

            requestAnimationFrame(detectPitchLoop);
        }

        // ==================== Ê∏∏Êàè‰∏ªÂæ™ÁéØ ====================
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            drawStaff();
            drawWaveRings();
            drawCurrentDemoNote();

            // Âè™ÊúâÂú®Èü≥È¢ëÂàùÂßãÂåñÂêéÊâçÊõ¥Êñ∞Èü≥Á¨¶‰ΩçÁΩÆ
            if (!audioContext || !audioInitialized) {
                requestAnimationFrame(gameLoop);
                return;
            }

            // ‰ª• AudioContext Êó∂Èó¥‰∏∫‰∏ªÊó∂Èíü
            const now = audioContext.currentTime;
            let phaseStartTime = 0;

            if (currentPhase === 'demo') {
                phaseStartTime = demoStartTime;
            } else if (currentPhase === 'perform') {
                phaseStartTime = performStartTime;
            } else {
                phaseStartTime = now;
            }

            // Êõ¥Êñ∞ÂíåÁªòÂà∂Èü≥Á¨¶
            for (let i = gameNotes.length - 1; i >= 0; i--) {
                if (!gameNotes[i].update(now, currentPhase, phaseStartTime)) {
                    gameNotes.splice(i, 1);
                } else {
                    gameNotes[i].draw(currentPhase);
                }
            }

            // Êõ¥Êñ∞ÂíåÁªòÂà∂ÂëΩ‰∏≠ÁÇπ
            for (let i = hitPoints.length - 1; i >= 0; i--) {
                if (!hitPoints[i].update()) {
                    hitPoints.splice(i, 1);
                } else {
                    hitPoints[i].draw();
                }
            }

            // Êõ¥Êñ∞ÂíåÁªòÂà∂ÁÆ≠Â§¥
            for (let i = arrows.length - 1; i >= 0; i--) {
                if (!arrows[i].update()) {
                    arrows.splice(i, 1);
                } else {
                    arrows[i].draw();
                }
            }

            requestAnimationFrame(gameLoop);
        }

        // ==================== ‰∫ã‰ª∂ÁªëÂÆö ====================
        const mainBtn = document.getElementById('mainBtn');

        mainBtn.addEventListener('click', () => {
            if (!gameRunning) {
                startGame();
            }
        });

        // ÂÅúÊ≠¢ÊåâÈíÆ
        document.getElementById('stopBtn').addEventListener('click', () => {
            if (gameRunning) {
                stopGame();
            }
        });

        // ÂÖ≥Âç°ÈÄâÊã©
        document.querySelectorAll('.btn-level').forEach(btn => {
            btn.addEventListener('click', () => {
                if (gameRunning) {
                    stopGame();
                }
                document.querySelectorAll('.btn-level').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentLevel = parseInt(btn.dataset.level);
            });
        });

        // Èü≥Ëâ≤ÈÄâÊã©
        document.querySelectorAll('.btn-sound').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.btn-sound').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedSoundType = btn.dataset.sound;
            });
        });

        document.getElementById('restartBtn').addEventListener('click', () => {
            document.getElementById('resultOverlay').classList.remove('show');
            startGame();
        });

        // ÂêØÂä®Ê∏∏ÊàèÂæ™ÁéØ
        gameLoop();

        // È°µÈù¢ÁÇπÂáªÊó∂ÂàùÂßãÂåñÈü≥È¢ë
        document.addEventListener('click', async () => {
            if (!audioInitialized) {
                await initAudio();
            }
        }, { once: true });
    </script>
</body>
</html>
